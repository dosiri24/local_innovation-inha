<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카카오맵 API 테스트</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .test-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .info-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e0e0e0;
        }
        
        .success {
            background: #e8f5e8 !important;
            border-color: #4caf50 !important;
            color: #2e7d32;
        }
        
        .error {
            background: #ffebee !important;
            border-color: #f44336 !important;
            color: #c62828;
        }
        
        .warning {
            background: #fff3e0 !important;
            border-color: #ff9800 !important;
            color: #e65100;
        }
        
        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 20px 0;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .api-test-results {
            max-height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗺️ 카카오맵 API 테스트 도구</h1>
        
        <!-- API 키 정보 -->
        <div class="test-section">
            <h3>1. API 키 정보</h3>
            <div id="api-key-info" class="info-box">
                <strong>API 키:</strong> <span id="api-key-display">로딩 중...</span><br>
                <strong>상태:</strong> <span id="api-key-status">확인 중...</span><br>
                <strong>도메인:</strong> <span id="current-domain">{{ request.host }}</span>
            </div>
        </div>
        
        <!-- 네트워크 연결 테스트 -->
        <div class="test-section">
            <h3>2. 네트워크 연결 테스트</h3>
            <button class="btn" onclick="testNetworkConnection()">연결 테스트 실행</button>
            <div id="network-test-result" class="info-box" style="display: none;">
                <div id="network-status"></div>
            </div>
        </div>
        
        <!-- 카카오맵 스크립트 로드 테스트 -->
        <div class="test-section">
            <h3>3. 카카오맵 스크립트 로드</h3>
            <button class="btn" onclick="loadKakaoScript()">스크립트 로드 테스트</button>
            <div id="script-load-result" class="info-box" style="display: none;">
                <div id="script-status"></div>
            </div>
        </div>
        
        <!-- 지도 초기화 테스트 -->
        <div class="test-section">
            <h3>4. 지도 초기화 테스트</h3>
            <button class="btn" onclick="testMapInitialization()">지도 초기화</button>
            <div id="map"></div>
            <div id="map-test-result" class="info-box" style="display: none;">
                <div id="map-status"></div>
            </div>
        </div>
        
        <!-- API 호출 테스트 -->
        <div class="test-section">
            <h3>5. 카카오 API 직접 호출 테스트</h3>
            <button class="btn" onclick="testDirectApiCall()">API 직접 호출</button>
            <div id="api-call-result" class="info-box" style="display: none;">
                <div id="api-call-status"></div>
                <div class="api-test-results" id="api-response"></div>
            </div>
        </div>
        
        <!-- 문제 해결 가이드 -->
        <div class="test-section">
            <h3>6. 문제 해결 가이드</h3>
            <div class="info-box">
                <h4>일반적인 문제점들:</h4>
                <ul>
                    <li><strong>403 Forbidden:</strong> API 키가 현재 도메인에 등록되지 않음</li>
                    <li><strong>401 Unauthorized:</strong> API 키가 유효하지 않거나 만료됨</li>
                    <li><strong>스크립트 로드 실패:</strong> 네트워크 연결 문제 또는 잘못된 API 키</li>
                    <li><strong>CORS 에러:</strong> 브라우저 보안 정책으로 인한 차단</li>
                </ul>
                
                <h4>해결 방법:</h4>
                <div class="code-block">
1. 카카오 개발자 콘솔 접속: https://developers.kakao.com/console/app
2. 애플리케이션 선택 또는 생성
3. 플랫폼 설정 → Web 플랫폼 추가
4. 사이트 도메인에 다음 추가:
   - http://127.0.0.1:8080
   - http://localhost:8080
   - http://{{ request.host }}
5. JavaScript 키 확인 및 .env 파일 업데이트
                </div>
            </div>
        </div>
        
        <!-- 테스트 로그 -->
        <div class="test-section">
            <h3>7. 실시간 테스트 로그</h3>
            <button class="btn" onclick="clearLogs()">로그 지우기</button>
            <div id="test-logs" class="api-test-results" style="height: 200px;">
                <div>테스트 로그가 여기에 표시됩니다...</div>
            </div>
        </div>
    </div>

    <script>
        // API 키 정보 표시
        const apiKey = "{{ kakao_api_key }}";
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-logs');
            const className = type === 'error' ? 'color: red' : type === 'success' ? 'color: green' : 'color: blue';
            logElement.innerHTML += `<div style="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('test-logs').innerHTML = '<div>테스트 로그가 여기에 표시됩니다...</div>';
        }
        
        // 페이지 로드 시 API 키 정보 표시
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('api-key-display').textContent = apiKey || '설정되지 않음';
            
            if (!apiKey) {
                document.getElementById('api-key-status').innerHTML = '<span style="color: red">❌ API 키가 설정되지 않았습니다</span>';
                document.getElementById('api-key-info').className = 'info-box error';
            } else {
                document.getElementById('api-key-status').innerHTML = '<span style="color: green">✅ API 키가 설정되어 있습니다</span>';
                document.getElementById('api-key-info').className = 'info-box success';
            }
            
            log('카카오맵 API 테스트 도구 초기화 완료');
            log(`API 키: ${apiKey ? '설정됨' : '설정되지 않음'}`);
            log(`현재 도메인: {{ request.host }}`);
        });
        
        // 네트워크 연결 테스트
        async function testNetworkConnection() {
            log('네트워크 연결 테스트 시작...');
            const resultDiv = document.getElementById('network-test-result');
            const statusDiv = document.getElementById('network-status');
            resultDiv.style.display = 'block';
            
            try {
                // 카카오 API 서버 연결 테스트
                const response = await fetch('https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + apiKey, {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                statusDiv.innerHTML = '✅ 카카오 서버 연결 성공';
                resultDiv.className = 'info-box success';
                log('네트워크 연결 테스트 성공', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = '❌ 네트워크 연결 실패: ' + error.message;
                resultDiv.className = 'info-box error';
                log('네트워크 연결 테스트 실패: ' + error.message, 'error');
            }
        }
        
        // 카카오맵 스크립트 로드 테스트
        function loadKakaoScript() {
            log('카카오맵 스크립트 로드 테스트 시작...');
            const resultDiv = document.getElementById('script-load-result');
            const statusDiv = document.getElementById('script-status');
            resultDiv.style.display = 'block';
            
            // 기존 스크립트 제거
            const existingScript = document.querySelector('script[src*="dapi.kakao.com"]');
            if (existingScript) {
                existingScript.remove();
                log('기존 카카오맵 스크립트 제거');
            }
            
            const script = document.createElement('script');
            const timestamp = new Date().getTime();
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}&autoload=false&_t=${timestamp}`;
            
            script.onload = function() {
                statusDiv.innerHTML = '✅ 카카오맵 스크립트 로드 성공';
                resultDiv.className = 'info-box success';
                log('카카오맵 스크립트 로드 성공', 'success');
                log('kakao 객체 존재: ' + (typeof kakao !== 'undefined'));
            };
            
            script.onerror = function(error) {
                statusDiv.innerHTML = '❌ 카카오맵 스크립트 로드 실패<br>API 키가 유효하지 않거나 도메인이 등록되지 않았을 수 있습니다.';
                resultDiv.className = 'info-box error';
                log('카카오맵 스크립트 로드 실패', 'error');
                log('오류 세부사항: ' + JSON.stringify(error), 'error');
            };
            
            document.head.appendChild(script);
            log('카카오맵 스크립트 태그 추가됨');
        }
        
        // 지도 초기화 테스트
        function testMapInitialization() {
            log('지도 초기화 테스트 시작...');
            const resultDiv = document.getElementById('map-test-result');
            const statusDiv = document.getElementById('map-status');
            resultDiv.style.display = 'block';
            
            if (typeof kakao === 'undefined') {
                statusDiv.innerHTML = '❌ 카카오맵 스크립트가 로드되지 않았습니다. 먼저 스크립트를 로드해주세요.';
                resultDiv.className = 'info-box error';
                log('카카오맵 스크립트가 로드되지 않음', 'error');
                return;
            }
            
            try {
                kakao.maps.load(() => {
                    const mapContainer = document.getElementById('map');
                    const mapOption = {
                        center: new kakao.maps.LatLng(37.4760, 126.6163), // 인천 차이나타운
                        level: 5
                    };
                    
                    const map = new kakao.maps.Map(mapContainer, mapOption);
                    
                    // 테스트 마커 추가
                    const markerPosition = new kakao.maps.LatLng(37.4760, 126.6163);
                    const marker = new kakao.maps.Marker({
                        position: markerPosition,
                        map: map
                    });
                    
                    // 인포윈도우 추가
                    const infowindow = new kakao.maps.InfoWindow({
                        content: '<div style="padding:10px;">테스트 마커<br>인천 차이나타운</div>'
                    });
                    
                    kakao.maps.event.addListener(marker, 'click', function() {
                        infowindow.open(map, marker);
                    });
                    
                    statusDiv.innerHTML = '✅ 카카오맵 초기화 성공<br>지도가 정상적으로 표시됩니다.';
                    resultDiv.className = 'info-box success';
                    log('카카오맵 초기화 성공', 'success');
                    log('테스트 마커 및 인포윈도우 추가 완료', 'success');
                });
            } catch (error) {
                statusDiv.innerHTML = '❌ 카카오맵 초기화 실패: ' + error.message;
                resultDiv.className = 'info-box error';
                log('카카오맵 초기화 실패: ' + error.message, 'error');
            }
        }
        
        // API 직접 호출 테스트
        async function testDirectApiCall() {
            log('카카오 API 직접 호출 테스트 시작...');
            const resultDiv = document.getElementById('api-call-result');
            const statusDiv = document.getElementById('api-call-status');
            const responseDiv = document.getElementById('api-response');
            resultDiv.style.display = 'block';
            
            try {
                // REST API 호출 테스트 (장소 검색)
                const response = await fetch(`https://dapi.kakao.com/v2/local/search/keyword.json?query=인천 차이나타운`, {
                    headers: {
                        'Authorization': `KakaoAK ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = '✅ 카카오 REST API 호출 성공';
                    resultDiv.className = 'info-box success';
                    responseDiv.innerHTML = JSON.stringify(data, null, 2);
                    log('카카오 REST API 호출 성공', 'success');
                    log(`검색 결과: ${data.documents.length}개 장소`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                statusDiv.innerHTML = '❌ 카카오 API 호출 실패: ' + error.message;
                resultDiv.className = 'info-box error';
                responseDiv.innerHTML = `에러 정보:\n${error.message}\n\nAPI 키: ${apiKey}\n현재 도메인: {{ request.host }}`;
                log('카카오 REST API 호출 실패: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
