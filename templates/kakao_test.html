<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤ë§µ API í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .test-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .info-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e0e0e0;
        }
        
        .success {
            background: #e8f5e8 !important;
            border-color: #4caf50 !important;
            color: #2e7d32;
        }
        
        .error {
            background: #ffebee !important;
            border-color: #f44336 !important;
            color: #c62828;
        }
        
        .warning {
            background: #fff3e0 !important;
            border-color: #ff9800 !important;
            color: #e65100;
        }
        
        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 20px 0;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .api-test-results {
            max-height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ API í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
        
        <!-- API í‚¤ ì •ë³´ -->
        <div class="test-section">
            <h3>1. API í‚¤ ì •ë³´</h3>
            <div id="api-key-info" class="info-box">
                <strong>API í‚¤:</strong> <span id="api-key-display">ë¡œë”© ì¤‘...</span><br>
                <strong>ìƒíƒœ:</strong> <span id="api-key-status">í™•ì¸ ì¤‘...</span><br>
                <strong>ë„ë©”ì¸:</strong> <span id="current-domain">{{ request.host }}</span>
            </div>
        </div>
        
        <!-- ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>2. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸</h3>
            <button class="btn" onclick="testNetworkConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <div id="network-test-result" class="info-box" style="display: none;">
                <div id="network-status"></div>
            </div>
        </div>
        
        <!-- ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>3. ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ</h3>
            <button class="btn" onclick="loadKakaoScript()">ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
            <div id="script-load-result" class="info-box" style="display: none;">
                <div id="script-status"></div>
            </div>
        </div>
        
        <!-- ì§€ë„ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>4. ì§€ë„ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</h3>
            <button class="btn" onclick="testMapInitialization()">ì§€ë„ ì´ˆê¸°í™”</button>
            <div id="map"></div>
            <div id="map-test-result" class="info-box" style="display: none;">
                <div id="map-status"></div>
            </div>
        </div>
        
        <!-- API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>5. ì¹´ì¹´ì˜¤ API ì§ì ‘ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</h3>
            <button class="btn" onclick="testDirectApiCall()">API ì§ì ‘ í˜¸ì¶œ</button>
            <div id="api-call-result" class="info-box" style="display: none;">
                <div id="api-call-status"></div>
                <div class="api-test-results" id="api-response"></div>
            </div>
        </div>
        
        <!-- ë¬¸ì œ í•´ê²° ê°€ì´ë“œ -->
        <div class="test-section">
            <h3>6. ë¬¸ì œ í•´ê²° ê°€ì´ë“œ</h3>
            <div class="info-box">
                <h4>ì¼ë°˜ì ì¸ ë¬¸ì œì ë“¤:</h4>
                <ul>
                    <li><strong>403 Forbidden:</strong> API í‚¤ê°€ í˜„ì¬ ë„ë©”ì¸ì— ë“±ë¡ë˜ì§€ ì•ŠìŒ</li>
                    <li><strong>401 Unauthorized:</strong> API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë¨</li>
                    <li><strong>ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:</strong> ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œ ë˜ëŠ” ì˜ëª»ëœ API í‚¤</li>
                    <li><strong>CORS ì—ëŸ¬:</strong> ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•œ ì°¨ë‹¨</li>
                </ul>
                
                <h4>í•´ê²° ë°©ë²•:</h4>
                <div class="code-block">
1. ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†” ì ‘ì†: https://developers.kakao.com/console/app
2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì„ íƒ ë˜ëŠ” ìƒì„±
3. í”Œë«í¼ ì„¤ì • â†’ Web í”Œë«í¼ ì¶”ê°€
4. ì‚¬ì´íŠ¸ ë„ë©”ì¸ì— ë‹¤ìŒ ì¶”ê°€:
   - http://127.0.0.1:8080
   - http://localhost:8080
   - http://{{ request.host }}
5. JavaScript í‚¤ í™•ì¸ ë° .env íŒŒì¼ ì—…ë°ì´íŠ¸
                </div>
            </div>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ ë¡œê·¸ -->
        <div class="test-section">
            <h3>7. ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ë¡œê·¸</h3>
            <button class="btn" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <div id="test-logs" class="api-test-results" style="height: 200px;">
                <div>í…ŒìŠ¤íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
            </div>
        </div>
    </div>

    <script>
        // API í‚¤ ì •ë³´ í‘œì‹œ
        const apiKey = "{{ kakao_api_key }}";
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-logs');
            const className = type === 'error' ? 'color: red' : type === 'success' ? 'color: green' : 'color: blue';
            logElement.innerHTML += `<div style="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('test-logs').innerHTML = '<div>í…ŒìŠ¤íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ API í‚¤ ì •ë³´ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('api-key-display').textContent = apiKey || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
            
            if (!apiKey) {
                document.getElementById('api-key-status').innerHTML = '<span style="color: red">âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>';
                document.getElementById('api-key-info').className = 'info-box error';
            } else {
                document.getElementById('api-key-status').innerHTML = '<span style="color: green">âœ… API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤</span>';
                document.getElementById('api-key-info').className = 'info-box success';
            }
            
            log('ì¹´ì¹´ì˜¤ë§µ API í…ŒìŠ¤íŠ¸ ë„êµ¬ ì´ˆê¸°í™” ì™„ë£Œ');
            log(`API í‚¤: ${apiKey ? 'ì„¤ì •ë¨' : 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}`);
            log(`í˜„ì¬ ë„ë©”ì¸: {{ request.host }}`);
        });
        
        // ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testNetworkConnection() {
            log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            const resultDiv = document.getElementById('network-test-result');
            const statusDiv = document.getElementById('network-status');
            resultDiv.style.display = 'block';
            
            try {
                // ì¹´ì¹´ì˜¤ API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
                const response = await fetch('https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + apiKey, {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                statusDiv.innerHTML = 'âœ… ì¹´ì¹´ì˜¤ ì„œë²„ ì—°ê²° ì„±ê³µ';
                resultDiv.className = 'info-box success';
                log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = 'âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨: ' + error.message;
                resultDiv.className = 'info-box error';
                log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í…ŒìŠ¤íŠ¸
        function loadKakaoScript() {
            log('ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            const resultDiv = document.getElementById('script-load-result');
            const statusDiv = document.getElementById('script-status');
            resultDiv.style.display = 'block';
            
            // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
            const existingScript = document.querySelector('script[src*="dapi.kakao.com"]');
            if (existingScript) {
                existingScript.remove();
                log('ê¸°ì¡´ ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ì œê±°');
            }
            
            const script = document.createElement('script');
            const timestamp = new Date().getTime();
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}&autoload=false&_t=${timestamp}`;
            
            script.onload = function() {
                statusDiv.innerHTML = 'âœ… ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì„±ê³µ';
                resultDiv.className = 'info-box success';
                log('ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì„±ê³µ', 'success');
                log('kakao ê°ì²´ ì¡´ì¬: ' + (typeof kakao !== 'undefined'));
            };
            
            script.onerror = function(error) {
                statusDiv.innerHTML = 'âŒ ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨<br>API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë„ë©”ì¸ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                resultDiv.className = 'info-box error';
                log('ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨', 'error');
                log('ì˜¤ë¥˜ ì„¸ë¶€ì‚¬í•­: ' + JSON.stringify(error), 'error');
            };
            
            document.head.appendChild(script);
            log('ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì¶”ê°€ë¨');
        }
        
        // ì§€ë„ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸
        function testMapInitialization() {
            log('ì§€ë„ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            const resultDiv = document.getElementById('map-test-result');
            const statusDiv = document.getElementById('map-status');
            resultDiv.style.display = 'block';
            
            if (typeof kakao === 'undefined') {
                statusDiv.innerHTML = 'âŒ ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.';
                resultDiv.className = 'info-box error';
                log('ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }
            
            try {
                kakao.maps.load(() => {
                    const mapContainer = document.getElementById('map');
                    const mapOption = {
                        center: new kakao.maps.LatLng(37.4760, 126.6163), // ì¸ì²œ ì°¨ì´ë‚˜íƒ€ìš´
                        level: 5
                    };
                    
                    const map = new kakao.maps.Map(mapContainer, mapOption);
                    
                    // í…ŒìŠ¤íŠ¸ ë§ˆì»¤ ì¶”ê°€
                    const markerPosition = new kakao.maps.LatLng(37.4760, 126.6163);
                    const marker = new kakao.maps.Marker({
                        position: markerPosition,
                        map: map
                    });
                    
                    // ì¸í¬ìœˆë„ìš° ì¶”ê°€
                    const infowindow = new kakao.maps.InfoWindow({
                        content: '<div style="padding:10px;">í…ŒìŠ¤íŠ¸ ë§ˆì»¤<br>ì¸ì²œ ì°¨ì´ë‚˜íƒ€ìš´</div>'
                    });
                    
                    kakao.maps.event.addListener(marker, 'click', function() {
                        infowindow.open(map, marker);
                    });
                    
                    statusDiv.innerHTML = 'âœ… ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì„±ê³µ<br>ì§€ë„ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.';
                    resultDiv.className = 'info-box success';
                    log('ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì„±ê³µ', 'success');
                    log('í…ŒìŠ¤íŠ¸ ë§ˆì»¤ ë° ì¸í¬ìœˆë„ìš° ì¶”ê°€ ì™„ë£Œ', 'success');
                });
            } catch (error) {
                statusDiv.innerHTML = 'âŒ ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message;
                resultDiv.className = 'info-box error';
                log('ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // API ì§ì ‘ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
        async function testDirectApiCall() {
            log('ì¹´ì¹´ì˜¤ API ì§ì ‘ í˜¸ì¶œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            const resultDiv = document.getElementById('api-call-result');
            const statusDiv = document.getElementById('api-call-status');
            const responseDiv = document.getElementById('api-response');
            resultDiv.style.display = 'block';
            
            try {
                // REST API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (ì¥ì†Œ ê²€ìƒ‰)
                const response = await fetch(`https://dapi.kakao.com/v2/local/search/keyword.json?query=ì¸ì²œ ì°¨ì´ë‚˜íƒ€ìš´`, {
                    headers: {
                        'Authorization': `KakaoAK ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = 'âœ… ì¹´ì¹´ì˜¤ REST API í˜¸ì¶œ ì„±ê³µ';
                    resultDiv.className = 'info-box success';
                    responseDiv.innerHTML = JSON.stringify(data, null, 2);
                    log('ì¹´ì¹´ì˜¤ REST API í˜¸ì¶œ ì„±ê³µ', 'success');
                    log(`ê²€ìƒ‰ ê²°ê³¼: ${data.documents.length}ê°œ ì¥ì†Œ`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                statusDiv.innerHTML = 'âŒ ì¹´ì¹´ì˜¤ API í˜¸ì¶œ ì‹¤íŒ¨: ' + error.message;
                resultDiv.className = 'info-box error';
                responseDiv.innerHTML = `ì—ëŸ¬ ì •ë³´:\n${error.message}\n\nAPI í‚¤: ${apiKey}\ní˜„ì¬ ë„ë©”ì¸: {{ request.host }}`;
                log('ì¹´ì¹´ì˜¤ REST API í˜¸ì¶œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
