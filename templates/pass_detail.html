<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï†úÎ¨ºÌè¨GO Ìå®Ïä§ - {{ pass_data.pass_id }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #16C2EE 0%, #0FA3D1 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .pass-id {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .created-at {
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 30px;
        }
        .pass-info {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .pass-info h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .label {
            font-weight: 600;
            color: #666;
        }
        .value {
            color: #333;
            font-weight: 500;
        }
        .benefits {
            margin-top: 30px;
        }
        .benefit-item {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .store-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .benefit-desc {
            color: #555;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .benefit-value {
            color: #27ae60;
            font-weight: bold;
            font-size: 16px;
        }
        .reason {
            background: #f1f3f4;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            font-style: italic;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        .back-btn {
            display: inline-block;
            background: #16C2EE;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 25px;
            margin-top: 20px;
            transition: background 0.3s;
        }
        .back-btn:hover {
            background: #0FA3D1;
        }
        
        /* map.htmlÏóêÏÑú Í∞ÄÏ†∏Ïò® Í∏∞Îä• Ïä§ÌÉÄÏùº */
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: white;
            color: #64748b;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: #16C2EE;
            color: #16C2EE;
            transform: translateY(-1px);
        }
        
        .filter-btn.active {
            background: #16C2EE;
            color: white;
            border-color: #16C2EE;
        }
        
        .legend {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .legend-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-text {
            font-size: 14px;
            color: #666;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #16C2EE;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .features-section {
            margin: 30px 0;
        }
        
        .features-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* ÏßÄÎèÑ Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
        .map-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .map-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .map-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        #map {
            width: 100%;
            height: 400px;
        }
        
        .route-controls {
            padding: 20px;
            background: #f8f9ff;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .route-btn {
            background: #16C2EE;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .route-btn:hover {
            background: #0FA3D1;
            transform: translateY(-1px);
        }
        
        .route-btn.active {
            background: #4facfe;
        }
        
        #route-info {
            background: white;
            margin: 10px 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="pass-id">Ìå®Ïä§ ID: {{ pass_data.pass_id }}</div>
            <div class="created-at">ÏÉùÏÑ±Ïùº: {{ pass_data.created_at }}</div>
        </div>
        
        <div class="content">
            <div class="pass-info">
                <h3>üìã Ìå®Ïä§ Ï†ïÎ≥¥</h3>
                <div class="info-row">
                    <span class="label">Ìå®Ïä§ ÌÉÄÏûÖ</span>
                    <span class="value">{{ pass_data.pass_type.value }}</span>
                </div>
                <div class="info-row">
                    <span class="label">ÌÖåÎßà</span>
                    <span class="value">{{ pass_data.theme.value }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Ìè¨Ìï® Îß§Ïû•</span>
                    <span class="value">{{ pass_data.stores|length }}Í∞ú</span>
                </div>
                <div class="info-row">
                    <span class="label">ÌòúÌÉù Í∞úÏàò</span>
                    <span class="value">{{ pass_data.benefits|length }}Í∞ú</span>
                </div>
            </div>

            <!-- ÌòúÌÉù ÏΩîÎìú ÏûÖÎ†•/Í≤ÄÏ¶ù ÏÑπÏÖò -->
            <div class="pass-info" style="margin-top: 10px;">
                <h3>üîê ÌòúÌÉù ÏΩîÎìú ÏÇ¨Ïö©</h3>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                    <input id="benefit-code" type="text" placeholder="Ïòà: ABCD-1234" 
                           style="flex:1; min-width: 200px; padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
                    <button onclick="validateCode()" class="route-btn" style="background:#4caf50">Í≤ÄÏ¶ù</button>
                    <button onclick="redeemCode()" class="route-btn">ÏÇ¨Ïö© Ï≤òÎ¶¨</button>
                </div>
                <div id="code-result" style="margin-top:10px; font-size:14px; color:#555;"></div>
            </div>
            
            <div class="features-section">
                <div class="features-title">üéØ Ìå®Ïä§ Í∏∞Îä•</div>
                
                <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-category="all">Ï†ÑÏ≤¥</button>
                    <button class="filter-btn" data-category="ÏùåÏãùÏ†ê">ÏùåÏãùÏ†ê</button>
                    <button class="filter-btn" data-category="Ïπ¥Ìéò">Ïπ¥Ìéò</button>
                    <button class="filter-btn" data-category="ÏÑúÏ†ê">ÏÑúÏ†ê</button>
                    <button class="filter-btn" data-category="ÏàôÎ∞ï">ÏàôÎ∞ï</button>
                    <button class="filter-btn" data-category="Ï≤¥Ìóò">Ï≤¥Ìóò</button>
                    <button class="filter-btn" data-category="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</button>
                </div>
                
                <!-- Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Î≤îÎ°Ä -->
                <div class="legend">
                    <div class="legend-title">Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Î∂ÑÎ•ò</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #ff6b6b;"></div>
                            <span class="legend-text">ÏùåÏãùÏ†ê</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #4ecdc4;"></div>
                            <span class="legend-text">Ïπ¥Ìéò</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #45b7d1;"></div>
                            <span class="legend-text">ÏÑúÏ†ê</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #96ceb4;"></div>
                            <span class="legend-text">ÏàôÎ∞ï</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #feca57;"></div>
                            <span class="legend-text">Ï≤¥Ìóò</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #a29bfe;"></div>
                            <span class="legend-text">Í∏∞ÌÉÄ</span>
                        </div>
                    </div>
                    
                    <!-- ÌÜµÍ≥Ñ Ï†ïÎ≥¥ -->
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-number" id="total-stores">{{ pass_data.stores|length }}</div>
                            <div class="stat-label">Ï¥ù Îß§Ïû•</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="visible-stores">{{ pass_data.stores|length }}</div>
                            <div class="stat-label">ÌëúÏãúÎêú Îß§Ïû•</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="selected-category">Ï†ÑÏ≤¥</div>
                            <div class="stat-label">ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ìå®Ïä§ Îç∞Ïù¥ÌÑ∞Î•º JavaScriptÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù Ï†ÄÏû• -->
            <script type="application/json" id="pass-store-data">
                [
                {% for store in pass_data.stores %}
                {
                    "name": "{{ store.name|e }}",
                    "category": "{{ store.category|e }}",
                    "latitude": {% if store.latitude %}{{ store.latitude }}{% else %}null{% endif %},
                    "longitude": {% if store.longitude %}{{ store.longitude }}{% else %}null{% endif %}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
                ]
            </script>
            
            <!-- Ïã§Ï†ú stores.jsonÏóêÏÑú ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Ïä§ÌÅ¨Î¶ΩÌä∏ -->
            <script type="application/json" id="all-stores-data">
                [
                {% for store_data in all_stores_with_coords %}
                {
                    "name": "{{ store_data.name|e }}",
                    "category": "{{ store_data.category|e }}",
                    "latitude": {% if store_data.latitude %}{{ store_data.latitude }}{% else %}null{% endif %},
                    "longitude": {% if store_data.longitude %}{{ store_data.longitude }}{% else %}null{% endif %}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
                ]
            </script>
            
            <!-- ÏßÄÎèÑ ÏÑπÏÖò Ï∂îÍ∞Ä -->
            <div class="map-container">
                <div class="map-header">
                    <h3>üó∫Ô∏è Ìå®Ïä§ Ïû•ÏÜå ÏßÄÎèÑ</h3>
                </div>
                
                <!-- ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ -->
                <div id="map"></div>
                <div class="route-controls">
                    <button class="route-btn" id="show-walking" onclick="showWalkingRoute()">üö∂ ÎèÑÎ≥¥ Í≤ΩÎ°ú</button>
                    <button class="route-btn" id="show-driving" onclick="showDrivingRoute()">üöó ÏûêÎèôÏ∞® Í≤ΩÎ°ú</button>
                    <button class="route-btn" onclick="clearRoutes()">üóëÔ∏è Í≤ΩÎ°ú ÏßÄÏö∞Í∏∞</button>
                </div>
                <div id="route-info"></div>
            </div>
            
            <div class="benefits">
                <h3>üè™ Ìè¨Ìï®Îêú Îß§Ïû•</h3>
                {% for store in pass_data.stores %}
                <div class="benefit-item store-item" data-category="{{ store.category }}">
                    <div class="store-name">{{ store.name }}</div>
                    <div class="benefit-desc">{{ store.description }}</div>
                    <div class="benefit-value">üìç {{ store.location }}</div>
                </div>
                {% endfor %}
            </div>
            
            <div class="benefits">
                <h3>üéÅ Ìè¨Ìï®Îêú ÌòúÌÉù</h3>
                {% for benefit in pass_data.benefits %}
                <div class="benefit-item benefit-only">
                    <div class="store-name">{{ benefit.store_name }}</div>
                    <div class="benefit-desc">{{ benefit.description }}</div>
                    <div class="benefit-value">üéØ {{ benefit.benefit_type }}</div>
                    {% if benefit.discount_rate %}
                    <div class="reason">ÔøΩ Ìï†Ïù∏Î•†: {{ benefit.discount_rate }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <div style="text-align: center;">
                <a href="/" class="back-btn">ÏÉà Ìå®Ïä§ ÎßåÎì§Í∏∞</a>
            </div>
        </div>
        
        <div class="footer">
            Ï†úÎ¨ºÌè¨GO Ìå®Ïä§ - Ïù∏Ï≤ú Ï†úÎ¨ºÌè¨Íµ¨Ïùò Ïà®ÏùÄ Î™ÖÏÜåÎ•º Î∞úÍ≤¨ÌïòÏÑ∏Ïöî
        </div>
    </div>
    
    <!-- Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ API Î°úÎìú (ÎπÑÎèôÍ∏∞ Î∞©ÏãùÏúºÎ°ú Î≥ÄÍ≤Ω) -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a67274a743814b8d146d016ae4ae47d8&libraries=services&autoload=false"></script>
    
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let map = null;
        let markers = [];
        let routePolylines = { walking: [], driving: [] };
        
        // Îëê ÏßÄÏ†ê Í∞ÑÏùò ÏßÅÏÑ† Í±∞Î¶¨ Í≥ÑÏÇ∞ (km)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        // Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ïù¥ÏõÉ ÏïåÍ≥†Î¶¨Ï¶òÏúºÎ°ú ÏµúÏ†Å Í≤ΩÎ°ú Ï∞æÍ∏∞
        function findOptimalRoute(markerItems) {
            if (markerItems.length < 2) return markerItems;
            
            const unvisited = [...markerItems]; // Î∞©Î¨∏ÌïòÏßÄ ÏïäÏùÄ ÎßàÏª§Îì§
            const route = []; // ÏµúÏ†Å Í≤ΩÎ°ú
            
            // Ï≤´ Î≤àÏß∏ ÎßàÏª§Î•º ÏãúÏûëÏ†êÏúºÎ°ú ÏÑ†ÌÉù (ÎòêÎäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú ÏãúÏûëÏ†ê)
            let current = unvisited[0];
            route.push(current);
            unvisited.splice(0, 1);
            
            // Î™®Îì† ÎßàÏª§Î•º Î∞©Î¨∏Ìï† ÎïåÍπåÏßÄ Î∞òÎ≥µ
            while (unvisited.length > 0) {
                let nearest = null;
                let nearestDistance = Infinity;
                let nearestIndex = -1;
                
                const currentPos = current.marker.getPosition();
                
                // ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎßàÏª§ Ï∞æÍ∏∞
                for (let i = 0; i < unvisited.length; i++) {
                    const markerPos = unvisited[i].marker.getPosition();
                    const distance = calculateDistance(
                        currentPos.getLat(), currentPos.getLng(),
                        markerPos.getLat(), markerPos.getLng()
                    );
                    
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearest = unvisited[i];
                        nearestIndex = i;
                    }
                }
                
                // Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎßàÏª§Î•º Í≤ΩÎ°úÏóê Ï∂îÍ∞Ä
                route.push(nearest);
                unvisited.splice(nearestIndex, 1);
                current = nearest;
            }
            
            return route;
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉâÏÉÅ Îß§Ìïë
        const categoryColors = {
            'ÏùåÏãùÏ†ê': '#ff6b6b',
            'Ïπ¥Ìéò': '#4ecdc4', 
            'ÏÑúÏ†ê': '#45b7d1',
            'ÏàôÎ∞ï': '#96ceb4',
            'Ï≤¥Ìóò': '#feca57',
            'Í∏∞ÌÉÄ': '#a29bfe'
        };
        
        // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî (Ïã§Ï†ú Ìå®Ïä§ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
        function initMap() {
            console.log('ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            // Ïπ¥Ïπ¥Ïò§ SDK ÌôïÏù∏
            if (typeof kakao === 'undefined') {
                console.log('Ïπ¥Ïπ¥Ïò§ SDK Î°úÎî© ÎåÄÍ∏∞ Ï§ë...');
                setTimeout(initMap, 1000);
                return;
            }
            
            console.log('Ïπ¥Ïπ¥Ïò§ SDK Ï§ÄÎπÑÎê®');
            // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
            kakao.maps.load(() => {
                try {
                    console.log('Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ Î°úÎìú ÏôÑÎ£å');
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer) {
                        console.error('ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                        return;
                    }
                    
                    const mapOption = {
                        center: new kakao.maps.LatLng(37.4759, 126.6168), // Ï†úÎ¨ºÌè¨Íµ¨ Ï§ëÏã¨
                        level: 5
                    };
                    
                    map = new kakao.maps.Map(mapContainer, mapOption);
                    console.log('ÏßÄÎèÑ ÏÉùÏÑ± ÏôÑÎ£å');
                    
                    // Ïã§Ï†ú Îß§Ïû• ÎßàÏª§ Ï∂îÍ∞Ä
                    addPassStoreMarkers();
                    
                    // ÏßÄÎèÑ ÌÅ¥Î¶≠ Î∞è ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
                    setupMapClickEvent();
                    setupKeyboardEvents();
                    
                } catch (error) {
                    console.error('ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                }
            });
        }
        
        // Ìå®Ïä§ Îß§Ïû• ÎßàÏª§ Ï∂îÍ∞Ä
        function addPassStoreMarkers() {
            try {
                // JSON Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Îß§Ïû• Ï†ïÎ≥¥ ÏùΩÍ∏∞
                const storeDataScript = document.getElementById('pass-store-data');
                if (!storeDataScript) {
                    console.error('pass-store-data ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                    return;
                }
                
                const passStores = JSON.parse(storeDataScript.textContent);
                console.log('Î°úÎìúÎêú Îß§Ïû• Îç∞Ïù¥ÌÑ∞:', passStores);
                
                // Ï†ÑÏ≤¥ stores Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÏúÑÏπò Ï†ïÎ≥¥ Ìè¨Ìï®)
                const allStoresScript = document.getElementById('all-stores-data');
                const allStores = allStoresScript ? JSON.parse(allStoresScript.textContent) : [];
                console.log('Ï†ÑÏ≤¥ stores Îç∞Ïù¥ÌÑ∞:', allStores);
                
                let markerCount = 0;
                passStores.forEach((store, index) => {
                    console.log(`Îß§Ïû• ${index + 1}: ${store.name}, Ï¢åÌëú: ${store.latitude}, ${store.longitude}`);
                    
                    let coordinates = {lat: store.latitude, lng: store.longitude};
                    
                    // ÏúÑÏπò Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ storesÏóêÏÑú Ï∞æÍ∏∞
                    if (!coordinates.lat || !coordinates.lng) {
                        const matchedStore = allStores.find(s => s.name === store.name);
                        if (matchedStore && matchedStore.latitude && matchedStore.longitude) {
                            coordinates = {lat: matchedStore.latitude, lng: matchedStore.longitude};
                            console.log(`${store.name}Ïùò Ï¢åÌëúÎ•º Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï∞æÏùå: ${coordinates.lat}, ${coordinates.lng}`);
                        }
                    }
                    
                    if (coordinates && coordinates.lat && coordinates.lng) {
                        const position = new kakao.maps.LatLng(coordinates.lat, coordinates.lng);
                        const marker = new kakao.maps.Marker({
                            position: position,
                            map: map
                        });
                        
                        console.log(`ÎßàÏª§ ${index + 1} ÏÉùÏÑ±Îê®: ${store.name}`);
                        
                        // Ïã§Ï†ú Îß§Ïû• Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ¨Ïö©
                        const category = store.category;
                        const color = categoryColors[category] || '#a29bfe';
                        
                        const infoWindow = new kakao.maps.InfoWindow({
                            content: `
                                <div style="padding: 15px; min-width: 280px; max-width: 350px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <div style="width: 24px; height: 24px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 10px;">${index + 1}</div>
                                        <h3 style="margin: 0; color: #1a202c; font-size: 16px; font-weight: bold;">${store.name}</h3>
                                    </div>
                                    <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${category}</span>
                                        <span style="color: #64748b; font-size: 12px;">Ï†úÎ¨ºÌè¨Íµ¨</span>
                                    </div>
                                    <p style="margin: 8px 0; color: #4a5568; font-size: 14px; line-height: 1.5;">ÏÑ†ÌÉùÎêú Ìå®Ïä§Ïóê Ìè¨Ìï®Îêú Îß§Ïû•ÏûÖÎãàÎã§.</p>
                                </div>
                            `,
                            removable: true // Í∏∞Î≥∏ X Î≤ÑÌäº ÌôúÏÑ±Ìôî
                        });
                        
                        // ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                        kakao.maps.event.addListener(marker, 'click', function() {
                            console.log(`ÎßàÏª§ ÌÅ¥Î¶≠Îê®: ${store.name}`);
                            // Îã§Î•∏ InfoWindowÎì§ Î™®Îëê Îã´Í∏∞
                            closeAllInfoWindows();
                            // ÌòÑÏû¨ InfoWindow Ïó¥Í∏∞
                            infoWindow.open(map, marker);
                            console.log(`InfoWindow Ïó¥Î¶º: ${store.name}`);
                            // ÌòÑÏû¨ Ïó¥Î¶∞ InfoWindowÎ•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
                            window.currentInfoWindow = infoWindow;
                        });
                        
                        markers.push({ marker: marker, infoWindow: infoWindow });
                        markerCount++;
                        console.log(`ÎßàÏª§ ÏôÑÎ£å: ${store.name}, Ï¥ù ÎßàÏª§ Ïàò: ${markerCount}`);
                    } else {
                        console.log(`ÏúÑÏπò Ï†ïÎ≥¥ ÏóÜÏùå: ${store.name} - ÎßàÏª§ ÏÉùÏÑ± Î∂àÍ∞Ä`);
                    }
                });
                
                console.log(`ÎßàÏª§ Ï∂îÍ∞Ä ÏôÑÎ£å: Ï¥ù ${markerCount}Í∞úÏùò ÎßàÏª§Í∞Ä ÏÉùÏÑ±Îê®`);
                
            } catch (error) {
                console.error('ÎßàÏª§ Ï∂îÍ∞Ä Ïò§Î•ò:', error);
            }
        }
        
        // Î™®Îì† InfoWindow Îã´Í∏∞ Ìï®Ïàò
        function closeAllInfoWindows() {
            markers.forEach(item => {
                if (item.infoWindow) {
                    item.infoWindow.close();
                }
            });
            window.currentInfoWindow = null;
        }
        

        
        // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïãú Î™®Îì† InfoWindow Îã´Í∏∞
        function setupMapClickEvent() {
            if (map) {
                kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                    closeAllInfoWindows();
                });
            }
        }
        
        // ESC ÌÇ§Î°ú InfoWindow Îã´Í∏∞
        function setupKeyboardEvents() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeAllInfoWindows();
                }
            });
        }
        
        // Îß§Ïû• Ï¢åÌëú Îß§Ìïë (Î≥ÑÎèÑ Î≥ÄÏàòÎ°ú Î∂ÑÎ¶¨)
        const storeCoordinatesMap = {
            'ÏõîÎØ∏ÎèÑ ÌöüÏßë': { lat: 37.47397220206862, lng: 126.59720509293857 },
            'Î¨∏ÌïôÏÜåÎß§Ï†ê': { lat: 37.47350937581703, lng: 126.62085286165087 },
            'ÏõêÎ≥¥ÎßåÎëê': { lat: 37.47534097822377, lng: 126.6191021259768 },
            'Î∏îÎ£®ÌïòÎùº': { lat: 37.474785094782234, lng: 126.6197545384214 },
            'Ïª¥Ìè¨Ï¶àÏª§Ìîº Ïù∏Ï≤úÏó≠Ï†ê': { lat: 37.47575138206574, lng: 126.6175752858422 },
            'Îñ°Î∞±ÌôîÏ†ê': { lat: 37.464676048899506, lng: 126.65645170902988 },
            'ÎØ∏Ìà¨Ïª§Ìîº': { lat: 37.47477702009911, lng: 126.59773755541127 },
            'ÌõÑÏ¶àÎ≤ÑÍ±∞': { lat: 37.47876840511246, lng: 126.6350534344891 },
            'Í¥ÄÎèôÏò§Î¶¨ÏßÑ': { lat: 37.47380588507801, lng: 126.62060883722839 },
            'Îß•ÎèÑÎÇ†Îìú ÎèôÏù∏Ï≤úÏ†ê': { lat: 37.474631420013694, lng: 126.63049416454899 },
            'Ïú†ÏÑ±Î∂ÑÏãù': { lat: 37.47143909737978, lng: 126.62694167021796 },
            'Í∞§Îü¨Î¶¨ÏßÄÏò§Ïπ¥Ìéò': { lat: 37.47221966205152, lng: 126.62093231910521 },
            'ÌíÄÎ¨∏Í¥ÄÍ¥ëÌò∏ÌÖî': { lat: 37.476648940968005, lng: 126.59910808078902 },
            'ÎåÄÏõêÌïúÏïΩÎ∞©': { lat: 37.47078856011132, lng: 126.62395964339234 },
            'Îã¨ÎπõÎã¥ÏüÅÏù¥': { lat: 37.472949720718084, lng: 126.5975806118575 },
            'Ï†úÎ¨ºÌè¨ ÏàòÏ†ú Îß•Ï£ºÏßë': { lat: 37.4762, lng: 126.6168 },
            'Ïò§ÎπàÌã∞ÏßÄ': { lat: 37.47213825583188, lng: 126.6265115970335 },
            'Íº¨ÎÅºÏò§ÏπòÌÇ®': { lat: 37.46290366258156, lng: 126.65705122072016 },
            'Ï∞®Ïù¥ÎÇòÌÉÄÏö¥ ÏßúÏû•Î©¥Ïßë Ïã†': { lat: 37.476929158354224, lng: 126.61929443594198 },
            'ÏõîÎØ∏ÎèÑÎûòÎØ∏': { lat: 37.475215698285076, lng: 126.59793380070307 },
            'Î™©Ìñ• Í≥µÎ∞©': { lat: 37.466464323960665, lng: 126.65912523900246 },
            'ÌïúÎØ∏ÏÑúÏ†ê': { lat: 37.47266789792542, lng: 126.6367270113497 },
            'ÏÜåÏ≤ú Í∞ÄÎßàÏÜ• ÏàúÎåÄ': { lat: 37.47201151193725, lng: 126.62243839144485 },
            'ÏõêÏ°∞Î∂ÄÏÇ∞ÌôúÏñ¥ÌöåÏ†ÑÎ¨∏Ï†ê': { lat: 37.473935416393665, lng: 126.59716567744273 },
            'Ï∞®Ïù¥ÎÇòÌÉÄÏö¥ ÏõêÎ≥¥Î≥ëÍ∞Ä': { lat: 37.47529455208249, lng: 126.6193963212099 },
            'ÎèôÏùºÍΩÉÌôîÏõê': { lat: 37.4638303054716, lng: 126.65917779283436 },
            'Ïã§ÌÉÄÎûò ÌÉÄÎ°ú': { lat: 37.470795836937675, lng: 126.62640541780281 },
            'ÍπÄÎ∞•Ï≤úÍµ≠ ÎèôÏù∏Ï≤úÏ†ê': { lat: 37.475038056622196, lng: 126.63060328419206 },
            'ÏõîÎØ∏ÎèÑ Î™®ÌÖî': { lat: 37.473810731870095, lng: 126.59731709301232 },
            'Ï∞®Ïù¥ÎÇòÌÉÄÏö¥ ÏÑ†Î¨ºÍ∞ÄÍ≤å Â≠îÂÆ∂': { lat: 37.478245159711086, lng: 126.61961415741513 },
            'Ï†úÎ¨ºÌè¨ ÎìúÎ£®ÏôÄÎÖ∏ÎûòÎ∞©': { lat: 37.46566541175356, lng: 126.65835025304366 },
            'ÎåÄÎèôÌïôÏÉùÎ∞±ÌôîÏ†ê': { lat: 37.47520478821763, lng: 126.6293415442479 },
            'Í∞úÌï≠Î°ú Î™ÖÏõîÏßë': { lat: 37.47200350306382, lng: 126.62281568711441 }
        };
        
        
        // ÎèÑÎ≥¥ Í≤ΩÎ°ú ÌëúÏãú (ÏµúÏ†Å Í≤ΩÎ°ú + Ïã§Ï†ú API ÏÇ¨Ïö©)
        function showWalkingRoute() {
            if (markers.length < 2) {
                alert('ÏµúÏÜå 2Í∞ú Ïù¥ÏÉÅÏùò Ïû•ÏÜåÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            clearRoutes();
            
            const routeBtn = document.getElementById('show-walking');
            if (routeBtn) {
                routeBtn.classList.add('active');
                routeBtn.textContent = 'üö∂ Í≤ΩÎ°ú ÏµúÏ†ÅÌôî Ï§ë...';
            }
            
            // ÏµúÏ†Å Í≤ΩÎ°ú Í≥ÑÏÇ∞
            const optimizedRoute = findOptimalRoute(markers);
            
            // ÏµúÏ†ÅÌôîÎêú Í≤ΩÎ°úÎ°ú ÏàúÏÑúÎåÄÎ°ú Ïó∞Í≤∞ÌïòÎäî Í≤ΩÎ°ú ÏÉùÏÑ±
            const routePromises = [];
            
            for (let i = 0; i < optimizedRoute.length - 1; i++) {
                const startMarkerItem = optimizedRoute[i];
                const endMarkerItem = optimizedRoute[i + 1];
                
                const startPos = startMarkerItem.marker.getPosition();
                const endPos = endMarkerItem.marker.getPosition();
                
                const routeData = {
                    start: {
                        lat: startPos.getLat(),
                        lng: startPos.getLng(),
                        name: `Ïû•ÏÜå ${i + 1}`
                    },
                    end: {
                        lat: endPos.getLat(),
                        lng: endPos.getLng(),
                        name: `Ïû•ÏÜå ${i + 2}`
                    }
                };
                
                const promise = fetch('/api/directions/walking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(routeData)
                })
                .then(response => response.json())
                .then(data => {
                    return { segmentIndex: i, data: data };
                })
                .catch(error => {
                    return { segmentIndex: i, data: { success: false, error: error.message } };
                });
                
                routePromises.push(promise);
            }
            
            // Î™®Îì† Íµ¨Í∞ÑÏùò Í≤ΩÎ°ú ÏôÑÎ£å ÎåÄÍ∏∞
            Promise.all(routePromises)
                .then(results => {
                    let totalDistance = 0;
                    let totalDuration = 0;
                    let successfulSegments = 0;
                    
                    results.forEach((result, index) => {
                        const { segmentIndex, data } = result;
                        
                        if (data.success && data.path && data.path.length > 1) {
                            // Í≤ΩÎ°ú Ìè¥Î¶¨ÎùºÏù∏ ÏÉùÏÑ±
                            const path = data.path.map(point => new kakao.maps.LatLng(point.lat, point.lng));
                            
                            const polyline = new kakao.maps.Polyline({
                                path: path,
                                strokeWeight: 4,
                                strokeColor: '#2563eb',
                                strokeOpacity: 0.8,
                                strokeStyle: 'solid'
                            });
                            
                            polyline.setMap(map);
                            routePolylines.walking.push(polyline);
                            
                            totalDistance += data.distance || 0;
                            totalDuration += data.duration || 0;
                            successfulSegments++;
                            
                        } else {
                            // Ïã§Ìå®Ìïú Íµ¨Í∞ÑÏùÄ ÏßÅÏÑ†ÏúºÎ°ú Ïó∞Í≤∞
                            const startMarkerItem = optimizedRoute[segmentIndex];
                            const endMarkerItem = optimizedRoute[segmentIndex + 1];
                            
                            const fallbackPath = [
                                startMarkerItem.marker.getPosition(),
                                endMarkerItem.marker.getPosition()
                            ];
                            
                            const fallbackPolyline = new kakao.maps.Polyline({
                                path: fallbackPath,
                                strokeWeight: 3,
                                strokeColor: '#94a3b8',
                                strokeOpacity: 0.6,
                                strokeStyle: 'shortdash'
                            });
                            
                            fallbackPolyline.setMap(map);
                            routePolylines.walking.push(fallbackPolyline);
                        }
                    });
                    
                    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    if (routeBtn) {
                        routeBtn.textContent = 'üö∂ ÏµúÏ†Å ÎèÑÎ≥¥ Í≤ΩÎ°ú';
                    }
                    
                    // Í≤ΩÎ°ú Ï†ïÎ≥¥ ÌëúÏãú
                    document.getElementById('route-info').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üö∂ ÏµúÏ†ÅÌôîÎêú ÎèÑÎ≥¥ Í≤ΩÎ°ú</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    Ï¥ù Í±∞Î¶¨: ${Math.round(totalDistance)}m | ÏòàÏÉÅ ÏãúÍ∞Ñ: ${Math.round(totalDuration)}Î∂Ñ | Í≤ΩÏú†ÏßÄ: ${optimizedRoute.length}Í∞ú
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    ÏÑ±Í≥µÌïú Íµ¨Í∞Ñ: ${successfulSegments}/${results.length}Í∞ú | Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÏàúÏÑúÎ°ú ÏµúÏ†ÅÌôî
                                </div>
                            </div>
                            <div style="color: #2563eb; font-weight: bold; font-size: 12px;">
                                ÏµúÎã® Í±∞Î¶¨ Í≤ΩÎ°ú
                            </div>
                        </div>
                    `;
                    document.getElementById('route-info').style.display = 'block';
                    
                })
                .catch(error => {
                    if (routeBtn) {
                        routeBtn.textContent = 'üö∂ Í≤ΩÎ°ú Ïò§Î•ò';
                        routeBtn.classList.remove('active');
                    }
                });
        }
        
        // ÏûêÎèôÏ∞® Í≤ΩÎ°ú ÌëúÏãú (ÏµúÏ†Å Í≤ΩÎ°ú + Ïã§Ï†ú ÎèÑÎ°ú API ÏÇ¨Ïö©)
        function showDrivingRoute() {
            if (markers.length < 2) {
                alert('ÏµúÏÜå 2Í∞ú Ïù¥ÏÉÅÏùò Ïû•ÏÜåÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            clearRoutes();
            
            const routeBtn = document.getElementById('show-driving');
            if (routeBtn) {
                routeBtn.classList.add('active');
                routeBtn.textContent = 'üöó Í≤ΩÎ°ú ÏµúÏ†ÅÌôî Ï§ë...';
            }
            
            // ÏµúÏ†Å Í≤ΩÎ°ú Í≥ÑÏÇ∞
            const optimizedRoute = findOptimalRoute(markers);
            
            // ÏµúÏ†ÅÌôîÎêú Í≤ΩÎ°úÎ°ú ÏàúÏÑúÎåÄÎ°ú Ïó∞Í≤∞ÌïòÎäî Í≤ΩÎ°ú ÏÉùÏÑ±
            const routePromises = [];
            
            for (let i = 0; i < optimizedRoute.length - 1; i++) {
                const startMarkerItem = optimizedRoute[i];
                const endMarkerItem = optimizedRoute[i + 1];
                
                const startPos = startMarkerItem.marker.getPosition();
                const endPos = endMarkerItem.marker.getPosition();
                
                const routeData = {
                    start: {
                        lat: startPos.getLat(),
                        lng: startPos.getLng(),
                        name: `Ïû•ÏÜå ${i + 1}`
                    },
                    end: {
                        lat: endPos.getLat(),
                        lng: endPos.getLng(),
                        name: `Ïû•ÏÜå ${i + 2}`
                    }
                };
                
                const promise = fetch('/api/directions/car', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(routeData)
                })
                .then(response => response.json())
                .then(data => {
                    return { segmentIndex: i, data: data };
                })
                .catch(error => {
                    return { segmentIndex: i, data: { success: false, error: error.message } };
                });
                
                routePromises.push(promise);
            }
            
            // Î™®Îì† Íµ¨Í∞ÑÏùò Í≤ΩÎ°ú ÏôÑÎ£å ÎåÄÍ∏∞
            Promise.all(routePromises)
                .then(results => {
                    let totalDistance = 0;
                    let totalDuration = 0;
                    let totalToll = 0;
                    let successfulSegments = 0;
                    let hasHighway = false;
                    
                    results.forEach((result, index) => {
                        const { segmentIndex, data } = result;
                        
                        if (data.success && data.path && data.path.length > 1) {
                            // Í≤ΩÎ°ú Ìè¥Î¶¨ÎùºÏù∏ ÏÉùÏÑ±
                            const path = data.path.map(point => new kakao.maps.LatLng(point.lat, point.lng));
                            
                            // Í≥†ÏÜçÎèÑÎ°ú Íµ¨Í∞ÑÏù¥ ÏûàÏúºÎ©¥ Îã§Î•∏ ÏÉâÏÉÅ
                            const hasHighwaySegment = data.road_info && data.road_info.highway_distance > 0;
                            if (hasHighwaySegment) hasHighway = true;
                            
                            const polyline = new kakao.maps.Polyline({
                                path: path,
                                strokeWeight: 5,
                                strokeColor: hasHighwaySegment ? '#dc2626' : '#ea580c',
                                strokeOpacity: 0.8,
                                strokeStyle: 'solid'
                            });
                            
                            polyline.setMap(map);
                            routePolylines.driving.push(polyline);
                            
                            totalDistance += data.distance || 0;
                            totalDuration += data.duration || 0;
                            totalToll += (data.toll_info && data.toll_info.cost) || 0;
                            successfulSegments++;
                            
                        } else {
                            // Ïã§Ìå®Ìïú Íµ¨Í∞ÑÏùÄ Ï†êÏÑ†ÏúºÎ°ú Ïó∞Í≤∞
                            const startMarkerItem = optimizedRoute[segmentIndex];
                            const endMarkerItem = optimizedRoute[segmentIndex + 1];
                            
                            const fallbackPath = [
                                startMarkerItem.marker.getPosition(),
                                endMarkerItem.marker.getPosition()
                            ];
                            
                            const fallbackPolyline = new kakao.maps.Polyline({
                                path: fallbackPath,
                                strokeWeight: 4,
                                strokeColor: '#94a3b8',
                                strokeOpacity: 0.6,
                                strokeStyle: 'longdash'
                            });
                            
                            fallbackPolyline.setMap(map);
                            routePolylines.driving.push(fallbackPolyline);
                        }
                    });
                    
                    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    if (routeBtn) {
                        routeBtn.textContent = 'üöó ÏµúÏ†Å ÏûêÎèôÏ∞® Í≤ΩÎ°ú';
                    }
                    
                    // Í≤ΩÎ°ú Ï†ïÎ≥¥ ÌëúÏãú
                    document.getElementById('route-info').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üöó ÏµúÏ†ÅÌôîÎêú ÏûêÎèôÏ∞® Í≤ΩÎ°ú</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    Ï¥ù Í±∞Î¶¨: ${(totalDistance / 1000).toFixed(1)}km | ÏòàÏÉÅ ÏãúÍ∞Ñ: ${Math.round(totalDuration)}Î∂Ñ | Í≤ΩÏú†ÏßÄ: ${optimizedRoute.length}Í∞ú
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    ÏÑ±Í≥µÌïú Íµ¨Í∞Ñ: ${successfulSegments}/${results.length}Í∞ú | Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÏàúÏÑúÎ°ú ÏµúÏ†ÅÌôî
                                    ${totalToll > 0 ? ` | ÌÜ®Í≤åÏù¥Ìä∏: ${totalToll.toLocaleString()}Ïõê` : ''}
                                    ${hasHighway ? ' | Í≥†ÏÜçÎèÑÎ°ú Ìè¨Ìï®' : ''}
                                </div>
                            </div>
                            <div style="color: #dc2626; font-weight: bold; font-size: 12px;">
                                ÏµúÎã® Í±∞Î¶¨ Í≤ΩÎ°ú
                            </div>
                        </div>
                    `;
                    document.getElementById('route-info').style.display = 'block';
                    
                })
                .catch(error => {
                    if (routeBtn) {
                        routeBtn.textContent = 'üöó Í≤ΩÎ°ú Ïò§Î•ò';
                        routeBtn.classList.remove('active');
                    }
                });
        }
        
        // Í≤ΩÎ°ú ÏßÄÏö∞Í∏∞
        function clearRoutes() {
            // Î™®Îì† Í≤ΩÎ°ú Ìè¥Î¶¨ÎùºÏù∏ Ï†úÍ±∞
            Object.values(routePolylines).forEach(polylines => {
                polylines.forEach(polyline => polyline.setMap(null));
            });
            routePolylines = { walking: [], driving: [] };
            
            // Î≤ÑÌäº ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            const walkingBtn = document.getElementById('show-walking');
            const drivingBtn = document.getElementById('show-driving');
            
            if (walkingBtn) {
                walkingBtn.classList.remove('active');
                walkingBtn.textContent = 'üö∂ ÎèÑÎ≥¥ Í≤ΩÎ°ú';
            }
            
            if (drivingBtn) {
                drivingBtn.classList.remove('active');
                drivingBtn.textContent = 'üöó ÏûêÎèôÏ∞® Í≤ΩÎ°ú';
            }
            
            // Í≤ΩÎ°ú Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) {
                routeInfo.style.display = 'none';
            }
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // ÌïÑÌÑ∞ Í∏∞Îä• Ï¥àÍ∏∞Ìôî
            const filterButtons = document.querySelectorAll('.filter-btn');
            const storeItems = document.querySelectorAll('.store-item'); // Îß§Ïû• ÏïÑÏù¥ÌÖúÎßå ÌïÑÌÑ∞ÎßÅ
            
            // Í∞Å Îß§Ïû• ÏïÑÏù¥ÌÖúÏóê Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉâÏÉÅ ÌëúÏãú
            storeItems.forEach(item => {
                const category = item.getAttribute('data-category');
                
                // Îß§Ïû• Ïù¥Î¶Ñ ÏòÜÏóê Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉâÏÉÅ ÌëúÏãú
                const colorIndicator = document.createElement('div');
                colorIndicator.style.cssText = `
                    width: 8px; height: 8px; border-radius: 50%;
                    background: ${categoryColors[category] || '#a29bfe'};
                    display: inline-block; margin-left: 8px; vertical-align: middle;
                `;
                item.querySelector('.store-name').appendChild(colorIndicator);
            });
            
            // ÌïÑÌÑ∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const selectedCategory = this.getAttribute('data-category');
                    let visibleCount = 0;
                    
                    storeItems.forEach(item => {
                        const itemCategory = item.getAttribute('data-category');
                        if (selectedCategory === 'all' || itemCategory === selectedCategory) {
                            item.style.display = 'block';
                            visibleCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('visible-stores').textContent = visibleCount;
                    document.getElementById('selected-category').textContent = 
                        selectedCategory === 'all' ? 'Ï†ÑÏ≤¥' : selectedCategory;
                });
            });
            
            // Ï¥àÍ∏∞ ÌÜµÍ≥Ñ ÏÑ§Ï†ï
            document.getElementById('visible-stores').textContent = storeItems.length;
            document.getElementById('selected-category').textContent = 'Ï†ÑÏ≤¥';
            
            // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
            console.log('ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏòàÏïΩÎê® (2Ï¥à ÌõÑ)');
            setTimeout(() => {
                console.log('ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî Ìò∏Ï∂ú');
                initMap();
            }, 2000);
        });
        
        // ÌòúÌÉù ÏΩîÎìú Í≤ÄÏ¶ù Ìï®Ïàò
        async function validateCode() {
            const code = (document.getElementById('benefit-code').value || '').trim().toUpperCase();
            const res = await fetch('/api/benefits/validate', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, pass_id: '{{ pass_data.pass_id }}' })
            });
            const data = await res.json();
            const el = document.getElementById('code-result');
            if (!data.success) { 
                el.textContent = `Í≤ÄÏ¶ù Ïã§Ìå®: ${data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`; 
                el.style.color = '#c53030'; 
                return; 
            }
            if (!data.valid) { 
                el.textContent = 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏΩîÎìúÏûÖÎãàÎã§.'; 
                el.style.color = '#c53030'; 
                return; 
            }
            el.style.color = data.used ? '#c53030' : '#2f855a';
            el.textContent = data.used ? 'Ïù¥ÎØ∏ ÏÇ¨Ïö©Îêú ÏΩîÎìúÏûÖÎãàÎã§.' : `Ïú†Ìö®Ìïú ÏΩîÎìúÏûÖÎãàÎã§: ${data.benefit.store_name} - ${data.benefit.description}`;
        }

        // ÌòúÌÉù ÏΩîÎìú ÏÇ¨Ïö© Ï≤òÎ¶¨ Ìï®Ïàò
        async function redeemCode() {
            const code = (document.getElementById('benefit-code').value || '').trim().toUpperCase();
            const res = await fetch('/api/benefits/redeem', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, pass_id: '{{ pass_data.pass_id }}' })
            });
            const data = await res.json();
            const el = document.getElementById('code-result');
            if (!data.success) { 
                el.textContent = `ÏÇ¨Ïö© Ïã§Ìå®: ${data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`; 
                el.style.color = '#c53030'; 
                return; 
            }
            el.style.color = '#2f855a';
            el.textContent = 'ÌòúÌÉùÏù¥ ÏÇ¨Ïö© Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.';
        }
    </script>
</body>
</html>
