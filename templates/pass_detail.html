<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œë¬¼í¬GO íŒ¨ìŠ¤ - {{ pass_data.pass_id }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #16C2EE 0%, #0FA3D1 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .pass-id {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .created-at {
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 30px;
        }
        .pass-info {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .pass-info h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .label {
            font-weight: 600;
            color: #666;
        }
        .value {
            color: #333;
            font-weight: 500;
        }
        .benefits {
            margin-top: 30px;
        }
        .benefit-item {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .store-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .benefit-desc {
            color: #555;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .benefit-value {
            color: #27ae60;
            font-weight: bold;
            font-size: 16px;
        }
        .reason {
            background: #f1f3f4;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            font-style: italic;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        .back-btn {
            display: inline-block;
            background: #16C2EE;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 25px;
            margin-top: 20px;
            transition: background 0.3s;
        }
        .back-btn:hover {
            background: #0FA3D1;
        }
        
        /* map.htmlì—ì„œ ê°€ì ¸ì˜¨ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: white;
            color: #64748b;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: #16C2EE;
            color: #16C2EE;
            transform: translateY(-1px);
        }
        
        .filter-btn.active {
            background: #16C2EE;
            color: white;
            border-color: #16C2EE;
        }
        
        .legend {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .legend-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-text {
            font-size: 14px;
            color: #666;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #16C2EE;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .features-section {
            margin: 30px 0;
        }
        
        .features-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* ì§€ë„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .map-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .map-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .map-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        #map {
            width: 100%;
            height: 400px;
        }
        
        .route-controls {
            padding: 20px;
            background: #f8f9ff;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .route-btn {
            background: #16C2EE;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .route-btn:hover {
            background: #0FA3D1;
            transform: translateY(-1px);
        }
        
        .route-btn.active {
            background: #4facfe;
        }
        
        #route-info {
            background: white;
            margin: 10px 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="pass-id">íŒ¨ìŠ¤ ID: {{ pass_data.pass_id }}</div>
            <div class="created-at">ìƒì„±ì¼: {{ pass_data.created_at }}</div>
        </div>
        
        <div class="content">
            <div class="pass-info">
                <h3>ğŸ“‹ íŒ¨ìŠ¤ ì •ë³´</h3>
                <div class="info-row">
                    <span class="label">íŒ¨ìŠ¤ íƒ€ì…</span>
                    <span class="value">{{ pass_data.pass_type.value }}</span>
                </div>
                <div class="info-row">
                    <span class="label">í…Œë§ˆ</span>
                    <span class="value">{{ pass_data.theme.value }}</span>
                </div>
                <div class="info-row">
                    <span class="label">í¬í•¨ ë§¤ì¥</span>
                    <span class="value">{{ pass_data.stores|length }}ê°œ</span>
                </div>
                <div class="info-row">
                    <span class="label">í˜œíƒ ê°œìˆ˜</span>
                    <span class="value">{{ pass_data.benefits|length }}ê°œ</span>
                </div>
            </div>

            <!-- í˜œíƒ ì½”ë“œ ì…ë ¥/ê²€ì¦ ì„¹ì…˜ -->
            <div class="pass-info" style="margin-top: 10px;">
                <h3>ğŸ” í˜œíƒ ì½”ë“œ ì‚¬ìš©</h3>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                    <input id="benefit-code" type="text" placeholder="ì˜ˆ: ABCD-1234" 
                           style="flex:1; min-width: 200px; padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
                    <button onclick="validateCode()" class="route-btn" style="background:#4caf50">ê²€ì¦</button>
                    <button onclick="redeemCode()" class="route-btn">ì‚¬ìš© ì²˜ë¦¬</button>
                </div>
                <div id="code-result" style="margin-top:10px; font-size:14px; color:#555;"></div>
            </div>
            
            <div class="features-section">
                <div class="features-title">ğŸ¯ íŒ¨ìŠ¤ ê¸°ëŠ¥</div>
                
                <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-category="all">ì „ì²´</button>
                    <button class="filter-btn" data-category="ìŒì‹ì ">ìŒì‹ì </button>
                    <button class="filter-btn" data-category="ì¹´í˜">ì¹´í˜</button>
                    <button class="filter-btn" data-category="ì„œì ">ì„œì </button>
                    <button class="filter-btn" data-category="ìˆ™ë°•">ìˆ™ë°•</button>
                    <button class="filter-btn" data-category="ì²´í—˜">ì²´í—˜</button>
                    <button class="filter-btn" data-category="ê¸°íƒ€">ê¸°íƒ€</button>
                </div>
                
                <!-- ì¹´í…Œê³ ë¦¬ë³„ ë²”ë¡€ -->
                <div class="legend">
                    <div class="legend-title">ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¥˜</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #ff6b6b;"></div>
                            <span class="legend-text">ìŒì‹ì </span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #4ecdc4;"></div>
                            <span class="legend-text">ì¹´í˜</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #45b7d1;"></div>
                            <span class="legend-text">ì„œì </span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #96ceb4;"></div>
                            <span class="legend-text">ìˆ™ë°•</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #feca57;"></div>
                            <span class="legend-text">ì²´í—˜</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker" style="background: #a29bfe;"></div>
                            <span class="legend-text">ê¸°íƒ€</span>
                        </div>
                    </div>
                    
                    <!-- í†µê³„ ì •ë³´ -->
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-number" id="total-stores">{{ pass_data.stores|length }}</div>
                            <div class="stat-label">ì´ ë§¤ì¥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="visible-stores">{{ pass_data.stores|length }}</div>
                            <div class="stat-label">í‘œì‹œëœ ë§¤ì¥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="selected-category">ì „ì²´</div>
                            <div class="stat-label">ì„ íƒëœ ì¹´í…Œê³ ë¦¬</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- íŒ¨ìŠ¤ ë°ì´í„°ë¥¼ JavaScriptì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì €ì¥ -->
            <script type="application/json" id="pass-store-data">
                [
                {% for store in pass_data.stores %}
                {
                    "name": "{{ store.name|e }}",
                    "category": "{{ store.category|e }}",
                    "latitude": {% if store.latitude %}{{ store.latitude }}{% else %}null{% endif %},
                    "longitude": {% if store.longitude %}{{ store.longitude }}{% else %}null{% endif %}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
                ]
            </script>
            
            <!-- ì‹¤ì œ stores.jsonì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìŠ¤í¬ë¦½íŠ¸ -->
            <script type="application/json" id="all-stores-data">
                [
                {% for store_data in all_stores_with_coords %}
                {
                    "name": "{{ store_data.name|e }}",
                    "category": "{{ store_data.category|e }}",
                    "latitude": {% if store_data.latitude %}{{ store_data.latitude }}{% else %}null{% endif %},
                    "longitude": {% if store_data.longitude %}{{ store_data.longitude }}{% else %}null{% endif %}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
                ]
            </script>
            
            <!-- ì§€ë„ ì„¹ì…˜ ì¶”ê°€ -->
            <div class="map-container">
                <div class="map-header">
                    <h3>ğŸ—ºï¸ íŒ¨ìŠ¤ ì¥ì†Œ ì§€ë„</h3>
                </div>
                
                <!-- ë””ë²„ê·¸ ì •ë³´ -->
                <div id="map"></div>
                <div class="route-controls">
                    <button class="route-btn" id="show-walking" onclick="showWalkingRoute()">ğŸš¶ ë„ë³´ ê²½ë¡œ</button>
                    <button class="route-btn" id="show-driving" onclick="showDrivingRoute()">ğŸš— ìë™ì°¨ ê²½ë¡œ</button>
                    <button class="route-btn" onclick="clearRoutes()">ğŸ—‘ï¸ ê²½ë¡œ ì§€ìš°ê¸°</button>
                </div>
                <div id="route-info"></div>
            </div>
            
            <div class="benefits">
                <h3>ğŸª í¬í•¨ëœ ë§¤ì¥</h3>
                {% for store in pass_data.stores %}
                <div class="benefit-item store-item" data-category="{{ store.category }}">
                    <div class="store-name">{{ store.name }}</div>
                    <div class="benefit-desc">{{ store.description }}</div>
                    <div class="benefit-value">ğŸ“ {{ store.location }}</div>
                </div>
                {% endfor %}
            </div>
            
            <div class="benefits">
                <h3>ğŸ í¬í•¨ëœ í˜œíƒ</h3>
                {% for benefit in pass_data.benefits %}
                <div class="benefit-item benefit-only">
                    <div class="store-name">{{ benefit.store_name }}</div>
                    <div class="benefit-desc">{{ benefit.description }}</div>
                    <div class="benefit-value">ğŸ¯ {{ benefit.benefit_type }}</div>
                    {% if benefit.discount_rate %}
                    <div class="reason">ï¿½ í• ì¸ë¥ : {{ benefit.discount_rate }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <div style="text-align: center;">
                <a href="/" class="back-btn">ìƒˆ íŒ¨ìŠ¤ ë§Œë“¤ê¸°</a>
            </div>
        </div>
        
        <div class="footer">
            ì œë¬¼í¬GO íŒ¨ìŠ¤ - ì¸ì²œ ì œë¬¼í¬êµ¬ì˜ ìˆ¨ì€ ëª…ì†Œë¥¼ ë°œê²¬í•˜ì„¸ìš”
        </div>
    </div>
    
    <!-- ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ (ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ë³€ê²½) -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a67274a743814b8d146d016ae4ae47d8&libraries=services&autoload=false"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map = null;
        let markers = [];
        let routePolylines = { walking: [], driving: [] };
        
        // ë‘ ì§€ì  ê°„ì˜ ì§ì„  ê±°ë¦¬ ê³„ì‚° (km)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        // ê°€ì¥ ê°€ê¹Œìš´ ì´ì›ƒ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìµœì  ê²½ë¡œ ì°¾ê¸°
        function findOptimalRoute(markerItems) {
            if (markerItems.length < 2) return markerItems;
            
            const unvisited = [...markerItems]; // ë°©ë¬¸í•˜ì§€ ì•Šì€ ë§ˆì»¤ë“¤
            const route = []; // ìµœì  ê²½ë¡œ
            
            // ì²« ë²ˆì§¸ ë§ˆì»¤ë¥¼ ì‹œì‘ì ìœ¼ë¡œ ì„ íƒ (ë˜ëŠ” ì‚¬ìš©ìê°€ ì„ íƒí•œ ì‹œì‘ì )
            let current = unvisited[0];
            route.push(current);
            unvisited.splice(0, 1);
            
            // ëª¨ë“  ë§ˆì»¤ë¥¼ ë°©ë¬¸í•  ë•Œê¹Œì§€ ë°˜ë³µ
            while (unvisited.length > 0) {
                let nearest = null;
                let nearestDistance = Infinity;
                let nearestIndex = -1;
                
                const currentPos = current.marker.getPosition();
                
                // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë§ˆì»¤ ì°¾ê¸°
                for (let i = 0; i < unvisited.length; i++) {
                    const markerPos = unvisited[i].marker.getPosition();
                    const distance = calculateDistance(
                        currentPos.getLat(), currentPos.getLng(),
                        markerPos.getLat(), markerPos.getLng()
                    );
                    
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearest = unvisited[i];
                        nearestIndex = i;
                    }
                }
                
                // ê°€ì¥ ê°€ê¹Œìš´ ë§ˆì»¤ë¥¼ ê²½ë¡œì— ì¶”ê°€
                route.push(nearest);
                unvisited.splice(nearestIndex, 1);
                current = nearest;
            }
            
            return route;
        }
        
        // ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ë§¤í•‘
        const categoryColors = {
            'ìŒì‹ì ': '#ff6b6b',
            'ì¹´í˜': '#4ecdc4', 
            'ì„œì ': '#45b7d1',
            'ìˆ™ë°•': '#96ceb4',
            'ì²´í—˜': '#feca57',
            'ê¸°íƒ€': '#a29bfe'
        };
        
        // ì§€ë„ ì´ˆê¸°í™” (ì‹¤ì œ íŒ¨ìŠ¤ ë°ì´í„° ì‚¬ìš©)
        function initMap() {
            console.log('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘');
            // ì¹´ì¹´ì˜¤ SDK í™•ì¸
            if (typeof kakao === 'undefined') {
                console.log('ì¹´ì¹´ì˜¤ SDK ë¡œë”© ëŒ€ê¸° ì¤‘...');
                setTimeout(initMap, 1000);
                return;
            }
            
            console.log('ì¹´ì¹´ì˜¤ SDK ì¤€ë¹„ë¨');
            // ì§€ë„ ì´ˆê¸°í™”
            kakao.maps.load(() => {
                try {
                    console.log('ì¹´ì¹´ì˜¤ ì§€ë„ ë¡œë“œ ì™„ë£Œ');
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer) {
                        console.error('ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }
                    
                    const mapOption = {
                        center: new kakao.maps.LatLng(37.4759, 126.6168), // ì œë¬¼í¬êµ¬ ì¤‘ì‹¬
                        level: 5
                    };
                    
                    map = new kakao.maps.Map(mapContainer, mapOption);
                    console.log('ì§€ë„ ìƒì„± ì™„ë£Œ');
                    
                    // ì‹¤ì œ ë§¤ì¥ ë§ˆì»¤ ì¶”ê°€
                    addPassStoreMarkers();
                    
                    // ì§€ë„ í´ë¦­ ë° í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì„¤ì •
                    setupMapClickEvent();
                    setupKeyboardEvents();
                    
                } catch (error) {
                    console.error('ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                }
            });
        }
        
        // íŒ¨ìŠ¤ ë§¤ì¥ ë§ˆì»¤ ì¶”ê°€
        function addPassStoreMarkers() {
            try {
                // JSON ë°ì´í„°ì—ì„œ ë§¤ì¥ ì •ë³´ ì½ê¸°
                const storeDataScript = document.getElementById('pass-store-data');
                if (!storeDataScript) {
                    console.error('pass-store-data ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const passStores = JSON.parse(storeDataScript.textContent);
                console.log('ë¡œë“œëœ ë§¤ì¥ ë°ì´í„°:', passStores);
                
                // ì „ì²´ stores ë°ì´í„° ë¡œë“œ (ìœ„ì¹˜ ì •ë³´ í¬í•¨)
                const allStoresScript = document.getElementById('all-stores-data');
                const allStores = allStoresScript ? JSON.parse(allStoresScript.textContent) : [];
                console.log('ì „ì²´ stores ë°ì´í„°:', allStores);
                
                let markerCount = 0;
                passStores.forEach((store, index) => {
                    console.log(`ë§¤ì¥ ${index + 1}: ${store.name}, ì¢Œí‘œ: ${store.latitude}, ${store.longitude}`);
                    
                    let coordinates = {lat: store.latitude, lng: store.longitude};
                    
                    // ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì „ì²´ storesì—ì„œ ì°¾ê¸°
                    if (!coordinates.lat || !coordinates.lng) {
                        const matchedStore = allStores.find(s => s.name === store.name);
                        if (matchedStore && matchedStore.latitude && matchedStore.longitude) {
                            coordinates = {lat: matchedStore.latitude, lng: matchedStore.longitude};
                            console.log(`${store.name}ì˜ ì¢Œí‘œë¥¼ ì „ì²´ ë°ì´í„°ì—ì„œ ì°¾ìŒ: ${coordinates.lat}, ${coordinates.lng}`);
                        }
                    }
                    
                    if (coordinates && coordinates.lat && coordinates.lng) {
                        const position = new kakao.maps.LatLng(coordinates.lat, coordinates.lng);
                        const marker = new kakao.maps.Marker({
                            position: position,
                            map: map
                        });
                        
                        console.log(`ë§ˆì»¤ ${index + 1} ìƒì„±ë¨: ${store.name}`);
                        
                        // ì‹¤ì œ ë§¤ì¥ ì¹´í…Œê³ ë¦¬ ì‚¬ìš©
                        const category = store.category;
                        const color = categoryColors[category] || '#a29bfe';
                        
                        const infoWindow = new kakao.maps.InfoWindow({
                            content: `
                                <div style="padding: 15px; min-width: 280px; max-width: 350px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <div style="width: 24px; height: 24px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 10px;">${index + 1}</div>
                                        <h3 style="margin: 0; color: #1a202c; font-size: 16px; font-weight: bold;">${store.name}</h3>
                                    </div>
                                    <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${category}</span>
                                        <span style="color: #64748b; font-size: 12px;">ì œë¬¼í¬êµ¬</span>
                                    </div>
                                    <p style="margin: 8px 0; color: #4a5568; font-size: 14px; line-height: 1.5;">ì„ íƒëœ íŒ¨ìŠ¤ì— í¬í•¨ëœ ë§¤ì¥ì…ë‹ˆë‹¤.</p>
                                </div>
                            `,
                            removable: true // ê¸°ë³¸ X ë²„íŠ¼ í™œì„±í™”
                        });
                        
                        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                        kakao.maps.event.addListener(marker, 'click', function() {
                            console.log(`ë§ˆì»¤ í´ë¦­ë¨: ${store.name}`);
                            // ë‹¤ë¥¸ InfoWindowë“¤ ëª¨ë‘ ë‹«ê¸°
                            closeAllInfoWindows();
                            // í˜„ì¬ InfoWindow ì—´ê¸°
                            infoWindow.open(map, marker);
                            console.log(`InfoWindow ì—´ë¦¼: ${store.name}`);
                            // í˜„ì¬ ì—´ë¦° InfoWindowë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                            window.currentInfoWindow = infoWindow;
                        });
                        
                        markers.push({ marker: marker, infoWindow: infoWindow });
                        markerCount++;
                        console.log(`ë§ˆì»¤ ì™„ë£Œ: ${store.name}, ì´ ë§ˆì»¤ ìˆ˜: ${markerCount}`);
                    } else {
                        console.log(`ìœ„ì¹˜ ì •ë³´ ì—†ìŒ: ${store.name} - ë§ˆì»¤ ìƒì„± ë¶ˆê°€`);
                    }
                });
                
                console.log(`ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ: ì´ ${markerCount}ê°œì˜ ë§ˆì»¤ê°€ ìƒì„±ë¨`);
                
            } catch (error) {
                console.error('ë§ˆì»¤ ì¶”ê°€ ì˜¤ë¥˜:', error);
            }
        }
        
        // ëª¨ë“  InfoWindow ë‹«ê¸° í•¨ìˆ˜
        function closeAllInfoWindows() {
            markers.forEach(item => {
                if (item.infoWindow) {
                    item.infoWindow.close();
                }
            });
            window.currentInfoWindow = null;
        }
        

        
        // ì§€ë„ í´ë¦­ ì‹œ ëª¨ë“  InfoWindow ë‹«ê¸°
        function setupMapClickEvent() {
            if (map) {
                kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                    closeAllInfoWindows();
                });
            }
        }
        
        // ESC í‚¤ë¡œ InfoWindow ë‹«ê¸°
        function setupKeyboardEvents() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeAllInfoWindows();
                }
            });
        }
        
        // ë§¤ì¥ ì¢Œí‘œ ë§¤í•‘ (ë³„ë„ ë³€ìˆ˜ë¡œ ë¶„ë¦¬)
        const storeCoordinatesMap = {
            'ì›”ë¯¸ë„ íšŸì§‘': { lat: 37.47397220206862, lng: 126.59720509293857 },
            'ë¬¸í•™ì†Œë§¤ì ': { lat: 37.47350937581703, lng: 126.62085286165087 },
            'ì›ë³´ë§Œë‘': { lat: 37.47534097822377, lng: 126.6191021259768 },
            'ë¸”ë£¨í•˜ë¼': { lat: 37.474785094782234, lng: 126.6197545384214 },
            'ì»´í¬ì¦ˆì»¤í”¼ ì¸ì²œì—­ì ': { lat: 37.47575138206574, lng: 126.6175752858422 },
            'ë–¡ë°±í™”ì ': { lat: 37.464676048899506, lng: 126.65645170902988 },
            'ë¯¸íˆ¬ì»¤í”¼': { lat: 37.47477702009911, lng: 126.59773755541127 },
            'í›„ì¦ˆë²„ê±°': { lat: 37.47876840511246, lng: 126.6350534344891 },
            'ê´€ë™ì˜¤ë¦¬ì§„': { lat: 37.47380588507801, lng: 126.62060883722839 },
            'ë§¥ë„ë‚ ë“œ ë™ì¸ì²œì ': { lat: 37.474631420013694, lng: 126.63049416454899 },
            'ìœ ì„±ë¶„ì‹': { lat: 37.47143909737978, lng: 126.62694167021796 },
            'ê°¤ëŸ¬ë¦¬ì§€ì˜¤ì¹´í˜': { lat: 37.47221966205152, lng: 126.62093231910521 },
            'í’€ë¬¸ê´€ê´‘í˜¸í…”': { lat: 37.476648940968005, lng: 126.59910808078902 },
            'ëŒ€ì›í•œì•½ë°©': { lat: 37.47078856011132, lng: 126.62395964339234 },
            'ë‹¬ë¹›ë‹´ìŸì´': { lat: 37.472949720718084, lng: 126.5975806118575 },
            'ì œë¬¼í¬ ìˆ˜ì œ ë§¥ì£¼ì§‘': { lat: 37.4762, lng: 126.6168 },
            'ì˜¤ë¹ˆí‹°ì§€': { lat: 37.47213825583188, lng: 126.6265115970335 },
            'ê¼¬ë¼ì˜¤ì¹˜í‚¨': { lat: 37.46290366258156, lng: 126.65705122072016 },
            'ì°¨ì´ë‚˜íƒ€ìš´ ì§œì¥ë©´ì§‘ ì‹ ': { lat: 37.476929158354224, lng: 126.61929443594198 },
            'ì›”ë¯¸ë„ë˜ë¯¸': { lat: 37.475215698285076, lng: 126.59793380070307 },
            'ëª©í–¥ ê³µë°©': { lat: 37.466464323960665, lng: 126.65912523900246 },
            'í•œë¯¸ì„œì ': { lat: 37.47266789792542, lng: 126.6367270113497 },
            'ì†Œì²œ ê°€ë§ˆì†¥ ìˆœëŒ€': { lat: 37.47201151193725, lng: 126.62243839144485 },
            'ì›ì¡°ë¶€ì‚°í™œì–´íšŒì „ë¬¸ì ': { lat: 37.473935416393665, lng: 126.59716567744273 },
            'ì°¨ì´ë‚˜íƒ€ìš´ ì›ë³´ë³‘ê°€': { lat: 37.47529455208249, lng: 126.6193963212099 },
            'ë™ì¼ê½ƒí™”ì›': { lat: 37.4638303054716, lng: 126.65917779283436 },
            'ì‹¤íƒ€ë˜ íƒ€ë¡œ': { lat: 37.470795836937675, lng: 126.62640541780281 },
            'ê¹€ë°¥ì²œêµ­ ë™ì¸ì²œì ': { lat: 37.475038056622196, lng: 126.63060328419206 },
            'ì›”ë¯¸ë„ ëª¨í…”': { lat: 37.473810731870095, lng: 126.59731709301232 },
            'ì°¨ì´ë‚˜íƒ€ìš´ ì„ ë¬¼ê°€ê²Œ å­”å®¶': { lat: 37.478245159711086, lng: 126.61961415741513 },
            'ì œë¬¼í¬ ë“œë£¨ì™€ë…¸ë˜ë°©': { lat: 37.46566541175356, lng: 126.65835025304366 },
            'ëŒ€ë™í•™ìƒë°±í™”ì ': { lat: 37.47520478821763, lng: 126.6293415442479 },
            'ê°œí•­ë¡œ ëª…ì›”ì§‘': { lat: 37.47200350306382, lng: 126.62281568711441 }
        };
        
        
        // ë„ë³´ ê²½ë¡œ í‘œì‹œ (ìµœì  ê²½ë¡œ + ì‹¤ì œ API ì‚¬ìš©)
        function showWalkingRoute() {
            if (markers.length < 2) {
                alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ì¥ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            clearRoutes();
            
            const routeBtn = document.getElementById('show-walking');
            if (routeBtn) {
                routeBtn.classList.add('active');
                routeBtn.textContent = 'ğŸš¶ ê²½ë¡œ ìµœì í™” ì¤‘...';
            }
            
            // ìµœì  ê²½ë¡œ ê³„ì‚°
            const optimizedRoute = findOptimalRoute(markers);
            
            // ìµœì í™”ëœ ê²½ë¡œë¡œ ìˆœì„œëŒ€ë¡œ ì—°ê²°í•˜ëŠ” ê²½ë¡œ ìƒì„±
            const routePromises = [];
            
            for (let i = 0; i < optimizedRoute.length - 1; i++) {
                const startMarkerItem = optimizedRoute[i];
                const endMarkerItem = optimizedRoute[i + 1];
                
                const startPos = startMarkerItem.marker.getPosition();
                const endPos = endMarkerItem.marker.getPosition();
                
                const routeData = {
                    start: {
                        lat: startPos.getLat(),
                        lng: startPos.getLng(),
                        name: `ì¥ì†Œ ${i + 1}`
                    },
                    end: {
                        lat: endPos.getLat(),
                        lng: endPos.getLng(),
                        name: `ì¥ì†Œ ${i + 2}`
                    }
                };
                
                const promise = fetch('/api/directions/walking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(routeData)
                })
                .then(response => response.json())
                .then(data => {
                    return { segmentIndex: i, data: data };
                })
                .catch(error => {
                    return { segmentIndex: i, data: { success: false, error: error.message } };
                });
                
                routePromises.push(promise);
            }
            
            // ëª¨ë“  êµ¬ê°„ì˜ ê²½ë¡œ ì™„ë£Œ ëŒ€ê¸°
            Promise.all(routePromises)
                .then(results => {
                    let totalDistance = 0;
                    let totalDuration = 0;
                    let successfulSegments = 0;
                    
                    results.forEach((result, index) => {
                        const { segmentIndex, data } = result;
                        
                        if (data.success && data.path && data.path.length > 1) {
                            // ê²½ë¡œ í´ë¦¬ë¼ì¸ ìƒì„±
                            const path = data.path.map(point => new kakao.maps.LatLng(point.lat, point.lng));
                            
                            const polyline = new kakao.maps.Polyline({
                                path: path,
                                strokeWeight: 4,
                                strokeColor: '#2563eb',
                                strokeOpacity: 0.8,
                                strokeStyle: 'solid'
                            });
                            
                            polyline.setMap(map);
                            routePolylines.walking.push(polyline);
                            
                            totalDistance += data.distance || 0;
                            totalDuration += data.duration || 0;
                            successfulSegments++;
                            
                        } else {
                            // ì‹¤íŒ¨í•œ êµ¬ê°„ì€ ì§ì„ ìœ¼ë¡œ ì—°ê²°
                            const startMarkerItem = optimizedRoute[segmentIndex];
                            const endMarkerItem = optimizedRoute[segmentIndex + 1];
                            
                            const fallbackPath = [
                                startMarkerItem.marker.getPosition(),
                                endMarkerItem.marker.getPosition()
                            ];
                            
                            const fallbackPolyline = new kakao.maps.Polyline({
                                path: fallbackPath,
                                strokeWeight: 3,
                                strokeColor: '#94a3b8',
                                strokeOpacity: 0.6,
                                strokeStyle: 'shortdash'
                            });
                            
                            fallbackPolyline.setMap(map);
                            routePolylines.walking.push(fallbackPolyline);
                        }
                    });
                    
                    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (routeBtn) {
                        routeBtn.textContent = 'ğŸš¶ ìµœì  ë„ë³´ ê²½ë¡œ';
                    }
                    
                    // ê²½ë¡œ ì •ë³´ í‘œì‹œ
                    document.getElementById('route-info').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>ğŸš¶ ìµœì í™”ëœ ë„ë³´ ê²½ë¡œ</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ì´ ê±°ë¦¬: ${Math.round(totalDistance)}m | ì˜ˆìƒ ì‹œê°„: ${Math.round(totalDuration)}ë¶„ | ê²½ìœ ì§€: ${optimizedRoute.length}ê°œ
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    ì„±ê³µí•œ êµ¬ê°„: ${successfulSegments}/${results.length}ê°œ | ê°€ì¥ ê°€ê¹Œìš´ ìˆœì„œë¡œ ìµœì í™”
                                </div>
                            </div>
                            <div style="color: #2563eb; font-weight: bold; font-size: 12px;">
                                ìµœë‹¨ ê±°ë¦¬ ê²½ë¡œ
                            </div>
                        </div>
                    `;
                    document.getElementById('route-info').style.display = 'block';
                    
                })
                .catch(error => {
                    if (routeBtn) {
                        routeBtn.textContent = 'ğŸš¶ ê²½ë¡œ ì˜¤ë¥˜';
                        routeBtn.classList.remove('active');
                    }
                });
        }
        
        // ìë™ì°¨ ê²½ë¡œ í‘œì‹œ (ìµœì  ê²½ë¡œ + ì‹¤ì œ ë„ë¡œ API ì‚¬ìš©)
        function showDrivingRoute() {
            if (markers.length < 2) {
                alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ì¥ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            clearRoutes();
            
            const routeBtn = document.getElementById('show-driving');
            if (routeBtn) {
                routeBtn.classList.add('active');
                routeBtn.textContent = 'ğŸš— ê²½ë¡œ ìµœì í™” ì¤‘...';
            }
            
            // ìµœì  ê²½ë¡œ ê³„ì‚°
            const optimizedRoute = findOptimalRoute(markers);
            
            // ìµœì í™”ëœ ê²½ë¡œë¡œ ìˆœì„œëŒ€ë¡œ ì—°ê²°í•˜ëŠ” ê²½ë¡œ ìƒì„±
            const routePromises = [];
            
            for (let i = 0; i < optimizedRoute.length - 1; i++) {
                const startMarkerItem = optimizedRoute[i];
                const endMarkerItem = optimizedRoute[i + 1];
                
                const startPos = startMarkerItem.marker.getPosition();
                const endPos = endMarkerItem.marker.getPosition();
                
                const routeData = {
                    start: {
                        lat: startPos.getLat(),
                        lng: startPos.getLng(),
                        name: `ì¥ì†Œ ${i + 1}`
                    },
                    end: {
                        lat: endPos.getLat(),
                        lng: endPos.getLng(),
                        name: `ì¥ì†Œ ${i + 2}`
                    }
                };
                
                const promise = fetch('/api/directions/car', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(routeData)
                })
                .then(response => response.json())
                .then(data => {
                    return { segmentIndex: i, data: data };
                })
                .catch(error => {
                    return { segmentIndex: i, data: { success: false, error: error.message } };
                });
                
                routePromises.push(promise);
            }
            
            // ëª¨ë“  êµ¬ê°„ì˜ ê²½ë¡œ ì™„ë£Œ ëŒ€ê¸°
            Promise.all(routePromises)
                .then(results => {
                    let totalDistance = 0;
                    let totalDuration = 0;
                    let totalToll = 0;
                    let successfulSegments = 0;
                    let hasHighway = false;
                    
                    results.forEach((result, index) => {
                        const { segmentIndex, data } = result;
                        
                        if (data.success && data.path && data.path.length > 1) {
                            // ê²½ë¡œ í´ë¦¬ë¼ì¸ ìƒì„±
                            const path = data.path.map(point => new kakao.maps.LatLng(point.lat, point.lng));
                            
                            // ê³ ì†ë„ë¡œ êµ¬ê°„ì´ ìˆìœ¼ë©´ ë‹¤ë¥¸ ìƒ‰ìƒ
                            const hasHighwaySegment = data.road_info && data.road_info.highway_distance > 0;
                            if (hasHighwaySegment) hasHighway = true;
                            
                            const polyline = new kakao.maps.Polyline({
                                path: path,
                                strokeWeight: 5,
                                strokeColor: hasHighwaySegment ? '#dc2626' : '#ea580c',
                                strokeOpacity: 0.8,
                                strokeStyle: 'solid'
                            });
                            
                            polyline.setMap(map);
                            routePolylines.driving.push(polyline);
                            
                            totalDistance += data.distance || 0;
                            totalDuration += data.duration || 0;
                            totalToll += (data.toll_info && data.toll_info.cost) || 0;
                            successfulSegments++;
                            
                        } else {
                            // ì‹¤íŒ¨í•œ êµ¬ê°„ì€ ì ì„ ìœ¼ë¡œ ì—°ê²°
                            const startMarkerItem = optimizedRoute[segmentIndex];
                            const endMarkerItem = optimizedRoute[segmentIndex + 1];
                            
                            const fallbackPath = [
                                startMarkerItem.marker.getPosition(),
                                endMarkerItem.marker.getPosition()
                            ];
                            
                            const fallbackPolyline = new kakao.maps.Polyline({
                                path: fallbackPath,
                                strokeWeight: 4,
                                strokeColor: '#94a3b8',
                                strokeOpacity: 0.6,
                                strokeStyle: 'longdash'
                            });
                            
                            fallbackPolyline.setMap(map);
                            routePolylines.driving.push(fallbackPolyline);
                        }
                    });
                    
                    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (routeBtn) {
                        routeBtn.textContent = 'ğŸš— ìµœì  ìë™ì°¨ ê²½ë¡œ';
                    }
                    
                    // ê²½ë¡œ ì •ë³´ í‘œì‹œ
                    document.getElementById('route-info').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>ğŸš— ìµœì í™”ëœ ìë™ì°¨ ê²½ë¡œ</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ì´ ê±°ë¦¬: ${(totalDistance / 1000).toFixed(1)}km | ì˜ˆìƒ ì‹œê°„: ${Math.round(totalDuration)}ë¶„ | ê²½ìœ ì§€: ${optimizedRoute.length}ê°œ
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    ì„±ê³µí•œ êµ¬ê°„: ${successfulSegments}/${results.length}ê°œ | ê°€ì¥ ê°€ê¹Œìš´ ìˆœì„œë¡œ ìµœì í™”
                                    ${totalToll > 0 ? ` | í†¨ê²Œì´íŠ¸: ${totalToll.toLocaleString()}ì›` : ''}
                                    ${hasHighway ? ' | ê³ ì†ë„ë¡œ í¬í•¨' : ''}
                                </div>
                            </div>
                            <div style="color: #dc2626; font-weight: bold; font-size: 12px;">
                                ìµœë‹¨ ê±°ë¦¬ ê²½ë¡œ
                            </div>
                        </div>
                    `;
                    document.getElementById('route-info').style.display = 'block';
                    
                })
                .catch(error => {
                    if (routeBtn) {
                        routeBtn.textContent = 'ğŸš— ê²½ë¡œ ì˜¤ë¥˜';
                        routeBtn.classList.remove('active');
                    }
                });
        }
        
        // ê²½ë¡œ ì§€ìš°ê¸°
        function clearRoutes() {
            // ëª¨ë“  ê²½ë¡œ í´ë¦¬ë¼ì¸ ì œê±°
            Object.values(routePolylines).forEach(polylines => {
                polylines.forEach(polyline => polyline.setMap(null));
            });
            routePolylines = { walking: [], driving: [] };
            
            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            const walkingBtn = document.getElementById('show-walking');
            const drivingBtn = document.getElementById('show-driving');
            
            if (walkingBtn) {
                walkingBtn.classList.remove('active');
                walkingBtn.textContent = 'ğŸš¶ ë„ë³´ ê²½ë¡œ';
            }
            
            if (drivingBtn) {
                drivingBtn.classList.remove('active');
                drivingBtn.textContent = 'ğŸš— ìë™ì°¨ ê²½ë¡œ';
            }
            
            // ê²½ë¡œ ì •ë³´ ìˆ¨ê¸°ê¸°
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) {
                routeInfo.style.display = 'none';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // í•„í„° ê¸°ëŠ¥ ì´ˆê¸°í™”
            const filterButtons = document.querySelectorAll('.filter-btn');
            const storeItems = document.querySelectorAll('.store-item'); // ë§¤ì¥ ì•„ì´í…œë§Œ í•„í„°ë§
            
            // ê° ë§¤ì¥ ì•„ì´í…œì— ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ í‘œì‹œ
            storeItems.forEach(item => {
                const category = item.getAttribute('data-category');
                
                // ë§¤ì¥ ì´ë¦„ ì˜†ì— ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ í‘œì‹œ
                const colorIndicator = document.createElement('div');
                colorIndicator.style.cssText = `
                    width: 8px; height: 8px; border-radius: 50%;
                    background: ${categoryColors[category] || '#a29bfe'};
                    display: inline-block; margin-left: 8px; vertical-align: middle;
                `;
                item.querySelector('.store-name').appendChild(colorIndicator);
            });
            
            // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const selectedCategory = this.getAttribute('data-category');
                    let visibleCount = 0;
                    
                    storeItems.forEach(item => {
                        const itemCategory = item.getAttribute('data-category');
                        if (selectedCategory === 'all' || itemCategory === selectedCategory) {
                            item.style.display = 'block';
                            visibleCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    document.getElementById('visible-stores').textContent = visibleCount;
                    document.getElementById('selected-category').textContent = 
                        selectedCategory === 'all' ? 'ì „ì²´' : selectedCategory;
                });
            });
            
            // ì´ˆê¸° í†µê³„ ì„¤ì •
            document.getElementById('visible-stores').textContent = storeItems.length;
            document.getElementById('selected-category').textContent = 'ì „ì²´';
            
            // ì§€ë„ ì´ˆê¸°í™” (ì•½ê°„ì˜ ì§€ì—° í›„)
            console.log('ì§€ë„ ì´ˆê¸°í™” ì˜ˆì•½ë¨ (2ì´ˆ í›„)');
            setTimeout(() => {
                console.log('ì§€ë„ ì´ˆê¸°í™” í˜¸ì¶œ');
                initMap();
            }, 2000);
        });
        
        // í˜œíƒ ì½”ë“œ ê²€ì¦ í•¨ìˆ˜
        async function validateCode() {
            const code = (document.getElementById('benefit-code').value || '').trim().toUpperCase();
            const res = await fetch('/api/benefits/validate', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, pass_id: '{{ pass_data.pass_id }}' })
            });
            const data = await res.json();
            const el = document.getElementById('code-result');
            if (!data.success) { 
                el.textContent = `ê²€ì¦ ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`; 
                el.style.color = '#c53030'; 
                return; 
            }
            if (!data.valid) { 
                el.textContent = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.'; 
                el.style.color = '#c53030'; 
                return; 
            }
            el.style.color = data.used ? '#c53030' : '#2f855a';
            el.textContent = data.used ? 'ì´ë¯¸ ì‚¬ìš©ëœ ì½”ë“œì…ë‹ˆë‹¤.' : `ìœ íš¨í•œ ì½”ë“œì…ë‹ˆë‹¤: ${data.benefit.store_name} - ${data.benefit.description}`;
        }

        // í˜œíƒ ì½”ë“œ ì‚¬ìš© ì²˜ë¦¬ í•¨ìˆ˜
        async function redeemCode() {
            const code = (document.getElementById('benefit-code').value || '').trim().toUpperCase();
            const res = await fetch('/api/benefits/redeem', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, pass_id: '{{ pass_data.pass_id }}' })
            });
            const data = await res.json();
            const el = document.getElementById('code-result');
            if (!data.success) { 
                el.textContent = `ì‚¬ìš© ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`; 
                el.style.color = '#c53030'; 
                return; 
            }
            el.style.color = '#2f855a';
            el.textContent = 'í˜œíƒì´ ì‚¬ìš© ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
        }
    </script>
</body>
</html>
