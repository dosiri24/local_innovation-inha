<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œë¬¼í¬GO íŒ¨ìŠ¤ - ì¶”ì²œ ì¥ì†Œ ì§€ë„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        .back-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .map-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .map-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .map-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .map-subtitle {
            opacity: 0.9;
        }
        
        #map {
            width: 100%;
            height: 600px;
        }
        
        .controls {
            padding: 1.5rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        
        .filter-btn {
            background: white;
            border: 2px solid #e2e8f0;
            color: #64748b;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .legend {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .legend-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .legend-text {
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.1rem;
            color: #64748b;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #e53e3e;
            background: #fed7d7;
            border-radius: 10px;
            margin: 1rem;
        }
        
        .places-list {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .places-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .place-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, #f8f9ff, #e6e9ff);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .place-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .place-marker-num {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            font-size: 14px;
        }
        
        .place-info {
            flex: 1;
        }
        
        .place-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }
        
        .place-desc {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .place-category {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 1rem;
            }
            
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">ì œë¬¼í¬GO íŒ¨ìŠ¤</div>
            <div>
                <a href="/main" class="back-btn">ë©”ì¸</a>
                <a href="/pass-generator" class="back-btn">íŒ¨ìŠ¤ ìƒì„±</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="map-container">
            <div class="map-header">
                <div class="map-title">AI ì¶”ì²œ ì¥ì†Œ ì§€ë„</div>
                <div class="map-subtitle">ë™ì¸ì²œì˜ ìˆ¨ê²¨ì§„ ë³´ì„ê°™ì€ ì¥ì†Œë“¤ì„ ë°œê²¬í•´ë³´ì„¸ìš”</div>
            </div>
            
            <div id="map-loading" class="loading">
                <div class="spinner"></div>
                <div>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div id="map"></div>
            
            <div class="controls">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-category="all">ì „ì²´</button>
                    <button class="filter-btn" data-category="ìŒì‹ì ">ìŒì‹ì </button>
                    <button class="filter-btn" data-category="ì¹´í˜">ì¹´í˜</button>
                    <button class="filter-btn" data-category="ì„œì ">ì„œì </button>
                    <button class="filter-btn" data-category="ìˆ™ë°•">ìˆ™ë°•</button>
                    <button class="filter-btn" data-category="ì²´í—˜">ì²´í—˜</button>
                    <button class="filter-btn" data-category="ê¸°íƒ€">ê¸°íƒ€</button>
                </div>
            </div>
        </div>
        
        <div class="places-list">
            <div class="places-title" id="places-title">ğŸ“ AIê°€ ì¶”ì²œí•œ ì¥ì†Œë“¤</div>
            <div id="places-container">
                <!-- ì¥ì†Œ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-title">ì¹´í…Œê³ ë¦¬ë³„ ë§ˆì»¤</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-marker" style="background: #ff6b6b;"></div>
                    <span class="legend-text">ìŒì‹ì </span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #4ecdc4;"></div>
                    <span class="legend-text">ì¹´í˜</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #45b7d1;"></div>
                    <span class="legend-text">ì„œì </span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #96ceb4;"></div>
                    <span class="legend-text">ìˆ™ë°•</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #feca57;"></div>
                    <span class="legend-text">ì²´í—˜</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #a29bfe;"></div>
                    <span class="legend-text">ê¸°íƒ€</span>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="total-places">0</div>
                    <div class="stat-label">ì´ ì¥ì†Œ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="visible-places">0</div>
                    <div class="stat-label">í‘œì‹œëœ ì¥ì†Œ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="selected-category">ì „ì²´</div>
                    <div class="stat-label">ì„ íƒëœ ì¹´í…Œê³ ë¦¬</div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}"></script>
    <script>
        let map;
        let markers = [];
        let allStores = [];
        
        // ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ë§¤í•‘
        const categoryColors = {
            'ìŒì‹ì ': '#ff6b6b',
            'ì¹´í˜': '#4ecdc4',
            'ì„œì ': '#45b7d1',
            'ìˆ™ë°•': '#96ceb4',
            'ì²´í—˜': '#feca57',
            'ì£¼ì ': '#fd79a8',
            'ì˜ë¥˜': '#fdcb6e',
            'ì•½êµ­': '#6c5ce7',
            'ì„œë¹„ìŠ¤': '#a29bfe',
            'í¸ì˜ì ': '#00b894',
            'ê½ƒì§‘': '#e17055',
            'ì˜¤ë½': '#74b9ff',
            'ë¬¸êµ¬ì ': '#81ecec',
            'ì œê³¼ì ': '#fab1a0',
            'ê¸°ë…í’ˆ': '#55a3ff'
        };
        
        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            console.log('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘');
            
            try {
                // ë¡œë”© í‘œì‹œ
                document.getElementById('map-loading').style.display = 'flex';
                
                const container = document.getElementById('map');
                const options = {
                    center: new kakao.maps.LatLng(37.4755, 126.6166), // ë™ì¸ì²œ ì¤‘ì‹¬
                    level: 4
                };
                
                map = new kakao.maps.Map(container, options);
                console.log('ì¹´ì¹´ì˜¤ ì§€ë„ ìƒì„± ì™„ë£Œ:', map);
                
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    document.getElementById('map-loading').style.display = 'none';
                }, 500);
                
                // ë§¤ì¥ ë°ì´í„° ë¡œë“œ
                setTimeout(loadStores, 1000);
                
            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì§€ë„ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // íŒ¨ìŠ¤ ë°ì´í„° ë¡œë“œ (ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ)
        function loadPassData() {
            try {
                const passDataStr = sessionStorage.getItem('currentPassData');
                if (passDataStr) {
                    const passData = JSON.parse(passDataStr);
                    console.log('íŒ¨ìŠ¤ ë°ì´í„° ë¡œë“œ:', passData);
                    return passData;
                }
                console.log('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— íŒ¨ìŠ¤ ë°ì´í„° ì—†ìŒ');
                return null;
            } catch (error) {
                console.error('íŒ¨ìŠ¤ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ë§¤ì¥ ë°ì´í„° ë¡œë“œ
        async function loadStores() {
            console.log('ë§¤ì¥ ë°ì´í„° ë¡œë“œ ì‹œì‘');
            
            try {
                // ë¨¼ì € íŒ¨ìŠ¤ ë°ì´í„° í™•ì¸
                const passData = loadPassData();
                
                if (passData && passData.stores && passData.stores.length > 0) {
                    console.log('íŒ¨ìŠ¤ì—ì„œ ì¶”ì²œëœ ë§¤ì¥ë“¤:', passData.stores);
                    
                    // ì „ì²´ ë§¤ì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const response = await fetch('/api/stores');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('ğŸŒ API ì „ì²´ ì‘ë‹µ:', data);
                    console.log('âœ… API ì„±ê³µ ì—¬ë¶€:', data.success);
                    console.log('ğŸ“Š API ë§¤ì¥ ìˆ˜:', data.count);
                    
                    if (data.success && data.stores) {
                        // ì¶”ì²œëœ ë§¤ì¥ë“¤ë§Œ í•„í„°ë§
                        const recommendedStoreNames = passData.stores.map(store => store.name);
                        const filteredStores = data.stores.filter(store => 
                            recommendedStoreNames.includes(store.name)
                        );
                        
                        // ì¶”ì²œëœ ë§¤ì¥ì˜ í˜œíƒ ì •ë³´ë„ ì¶”ê°€
                        filteredStores.forEach(store => {
                            const passStore = passData.stores.find(ps => ps.name === store.name);
                            if (passStore) {
                                store.recommendedBenefit = passStore.desc;
                            }
                        });
                        
                        allStores = filteredStores;
                        console.log('âœ¨ íŒ¨ìŠ¤ì—ì„œ ì¶”ì²œëœ', filteredStores.length, 'ê°œ ë§¤ì¥ ë¡œë“œ');
                        
                        // ì²« ë²ˆì§¸ ë§¤ì¥ì˜ ì¢Œí‘œ í™•ì¸
                        if (filteredStores.length > 0) {
                            const firstStore = filteredStores[0];
                            console.log('ğŸ¯ ì²« ë²ˆì§¸ ë§¤ì¥ ìƒ˜í”Œ:', {
                                name: firstStore.name,
                                latitude: firstStore.latitude,
                                longitude: firstStore.longitude,
                                hasCoordinates: !!(firstStore.latitude && firstStore.longitude)
                            });
                        }
                        
                        // íŒ¨ìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸
                        updatePassHeader(passData);
                    } else {
                        throw new Error('ë§¤ì¥ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                    }
                } else {
                    console.log('íŒ¨ìŠ¤ ë°ì´í„°ê°€ ì—†ìŒ, ì „ì²´ ë§¤ì¥ í‘œì‹œ');
                    // íŒ¨ìŠ¤ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë§¤ì¥ í‘œì‹œ
                    const response = await fetch('/api/stores');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.stores) {
                        allStores = data.stores;
                        console.log('ğŸŒ ì „ì²´', allStores.length, 'ê°œ ë§¤ì¥ ë¡œë“œ');
                        
                        // ì²« ë²ˆì§¸ ë§¤ì¥ì˜ ì¢Œí‘œ í™•ì¸
                        if (allStores.length > 0) {
                            const firstStore = allStores[0];
                            console.log('ğŸ¯ ì²« ë²ˆì§¸ ë§¤ì¥ ìƒ˜í”Œ:', {
                                name: firstStore.name,
                                latitude: firstStore.latitude,
                                longitude: firstStore.longitude,
                                hasCoordinates: !!(firstStore.latitude && firstStore.longitude)
                            });
                        }
                        
                        // ê¸°ë³¸ í—¤ë” ì„¤ì •
                        updateDefaultHeader();
                    } else {
                        throw new Error('ë§¤ì¥ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                    }
                }
                
                // ë§ˆì»¤ ìƒì„± ë° í‘œì‹œ
                console.log('ğŸ“ ë§ˆì»¤ ìƒì„± ì‹œì‘ - ì´', allStores.length, 'ê°œ ë§¤ì¥');
                createMarkers();
                renderPlacesList(allStores);
                updateStats();
                
            } catch (error) {
                console.error('ë§¤ì¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                // ìƒ˜í”Œ ë°ì´í„°ë¡œ í´ë°±
                loadSampleData();
            }
        }
        
        // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
        function loadSampleData() {
            console.log('ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©');
            allStores = [
                {
                    id: 'S001',
                    name: 'ì›”ë¯¸ë„ íšŸì§‘',
                    category: 'ìŒì‹ì ',
                    area: 'ì›”ë¯¸ë„',
                    themes: ['í•´ì‚°ë¬¼', 'ë°”ë‹¤ì „ë§'],
                    desc: 'ì‹ ì„ í•œ í•´ì‚°ë¬¼ì„ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ê³³',
                    latitude: 37.47397220206862,
                    longitude: 126.59720509293857,
                    reviews: 250
                },
                {
                    id: 'S002',
                    name: 'ë¬¸í•™ì†Œë§¤ì ',
                    category: 'ì„œì ',
                    area: 'ê°œí•­ë¡œ',
                    themes: ['ë ˆíŠ¸ë¡œ', 'ë…ë¦½ì„œì '],
                    desc: 'ì˜¤ë˜ëœ ì±…ê³¼ ì´ì•¼ê¸°ê°€ ìˆëŠ” ê³³',
                    latitude: 37.47350937581703,
                    longitude: 126.62085286165087,
                    reviews: 15
                },
                {
                    id: 'S003',
                    name: 'ì›ë³´ë§Œë‘',
                    category: 'ìŒì‹ì ',
                    area: 'ì°¨ì´ë‚˜íƒ€ìš´',
                    themes: ['ì¤‘ì‹', 'ì „í†µ'],
                    desc: 'ì „í†µ ë°©ì‹ìœ¼ë¡œ ë§Œë“  ìˆ˜ì œ ë§Œë‘',
                    latitude: 37.47534097822377,
                    longitude: 126.6191021259768,
                    reviews: 180
                },
                {
                    id: 'S004',
                    name: 'ë¸”ë£¨í•˜ë¼',
                    category: 'ì¹´í˜',
                    area: 'ê³¨ëª©ìƒê¶Œ',
                    themes: ['ì¡°ìš©í•¨', 'í•¸ë“œë“œë¦½'],
                    desc: 'ì¡°ìš©í•œ ê³¨ëª© ì† ìˆ¨ì€ ì¹´í˜',
                    latitude: 37.474785094782234,
                    longitude: 126.6197545384214,
                    reviews: 30
                },
                {
                    id: 'S005',
                    name: 'ë°”ë‹¤í’ê²½ íœì…˜ì¹´í˜',
                    category: 'ì¹´í˜',
                    area: 'ì›”ë¯¸ë„',
                    themes: ['ë°”ë‹¤ì „ë§', 'íœì…˜'],
                    desc: 'ë°”ë‹¤ë¥¼ ë³´ë©° ì»¤í”¼ë¥¼ ë§ˆì‹¤ ìˆ˜ ìˆëŠ” ê³³',
                    latitude: 37.4758,
                    longitude: 126.5951,
                    reviews: 120
                }
            ];
            
            createMarkers();
            renderPlacesList(allStores);
            updateStats();
        }
        
        // ë§ˆì»¤ ìƒì„± (ê°„ë‹¨í•˜ê³  í™•ì‹¤í•œ ë°©ë²•)
        function createMarkers() {
            console.log('ë§ˆì»¤ ìƒì„± ì‹œì‘, ë§¤ì¥ ìˆ˜:', allStores.length);
            
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            clearMarkers();
            
            if (!map) {
                console.error('ì§€ë„ ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            let validMarkerCount = 0;
            const bounds = new kakao.maps.LatLngBounds();
            
            allStores.forEach((store, index) => {
                if (store.latitude && store.longitude) {
                    try {
                        const position = new kakao.maps.LatLng(store.latitude, store.longitude);
                        console.log(`ë§ˆì»¤ ${index + 1} ìœ„ì¹˜:`, store.name, position.getLat(), position.getLng());
                        
                        // ê¸°ë³¸ ë§ˆì»¤ ìƒì„± (ë¨¼ì € ë‹¨ìˆœí•œ ë§ˆì»¤ë¡œ)
                        const marker = new kakao.maps.Marker({
                            position: position,
                            map: map,
                            title: store.name
                        });
                        
                        console.log(`ë§ˆì»¤ ${index + 1} ìƒì„±:`, marker);
                        
                        // ì¸í¬ìœˆë„ìš° ìƒì„±
                        const infoWindow = createInfoWindow(store, index + 1);
                        
                        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                        kakao.maps.event.addListener(marker, 'click', function() {
                            console.log('ë§ˆì»¤ í´ë¦­:', store.name);
                            // ë‹¤ë¥¸ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
                            closeAllInfoWindows();
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push({
                            marker: marker,
                            infoWindow: infoWindow,
                            store: store
                        });
                        
                        bounds.extend(position);
                        validMarkerCount++;
                        
                        console.log(`ë§ˆì»¤ ${index + 1} ìƒì„± ì™„ë£Œ: ${store.name}`);
                        
                    } catch (error) {
                        console.error(`ë§ˆì»¤ ìƒì„± ì˜¤ë¥˜ (${store.name}):`, error);
                    }
                } else {
                    console.warn(`ì¢Œí‘œ ì •ë³´ ì—†ìŒ: ${store.name}`);
                }
            });
            
            console.log(`ì´ ${validMarkerCount}ê°œ ë§ˆì»¤ ìƒì„± ì™„ë£Œ`);
            console.log('ìƒì„±ëœ ë§ˆì»¤ë“¤:', markers);
            
            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (validMarkerCount > 0) {
                try {
                    console.log('ì§€ë„ ë²”ìœ„ ì¡°ì • ì¤‘...');
                    map.setBounds(bounds);
                    
                    // ë‹¨ì¼ ë§ˆì»¤ì¸ ê²½ìš° ì ì ˆí•œ ì¤Œ ë ˆë²¨ ì„¤ì •
                    setTimeout(() => {
                        if (validMarkerCount === 1) {
                            map.setLevel(4);
                        } else if (map.getLevel() > 6) {
                            map.setLevel(6);
                        }
                        console.log('ì§€ë„ ë ˆë²¨ ì¡°ì • ì™„ë£Œ:', map.getLevel());
                    }, 500);
                    
                } catch (error) {
                    console.error('ì§€ë„ ë²”ìœ„ ì¡°ì • ì˜¤ë¥˜:', error);
                }
            } else {
                console.warn('í‘œì‹œí•  ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤');
            }
        }
        
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        function clearMarkers() {
            markers.forEach(item => {
                if (item.marker) {
                    item.marker.setMap(null);
                }
                if (item.infoWindow) {
                    item.infoWindow.close();
                }
            });
            markers = [];
        }
        
        // ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸°
        function closeAllInfoWindows() {
            markers.forEach(item => {
                if (item.infoWindow) {
                    item.infoWindow.close();
                }
            });
        }
        
        // ì¸í¬ìœˆë„ìš° ìƒì„±
        function createInfoWindow(store, number) {
            const themes = Array.isArray(store.themes) ? store.themes.join(', ') : '';
            const reviewText = store.reviews ? `â­ ${store.reviews}ê°œ ë¦¬ë·°` : '';
            const benefitText = store.recommendedBenefit ? `ğŸ ${store.recommendedBenefit}` : '';
            const color = categoryColors[store.category] || '#a29bfe';
            
            const content = `
                <div style="padding: 15px; min-width: 280px; max-width: 350px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="width: 24px; height: 24px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 10px;">${number}</div>
                        <h3 style="margin: 0; color: #1a202c; font-size: 16px; font-weight: bold;">${store.name}</h3>
                    </div>
                    <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${store.category}</span>
                        <span style="color: #64748b; font-size: 12px;">${store.area}</span>
                    </div>
                    <p style="margin: 8px 0; color: #4a5568; font-size: 14px; line-height: 1.5;">${store.desc}</p>
                    ${benefitText ? `<div style="margin: 12px 0; padding: 8px; background: #f0f9ff; border-left: 4px solid #0ea5e9; border-radius: 4px;"><div style="color: #0c4a6e; font-size: 13px; font-weight: 500;">${benefitText}</div></div>` : ''}
                    ${themes ? `<div style="margin: 8px 0; color: #667eea; font-size: 12px;"><strong>í…Œë§ˆ:</strong> ${themes}</div>` : ''}
                    ${reviewText ? `<div style="margin: 8px 0; color: #ed8936; font-size: 12px;">${reviewText}</div>` : ''}
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="showRoute(${store.latitude}, ${store.longitude}, '${store.name}')" style="background: ${color}; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">ê¸¸ì°¾ê¸°</button>
                    </div>
                </div>
            `;
            
            return new kakao.maps.InfoWindow({
                content: content,
                removable: true
            });
        }
        
        // ì¥ì†Œ ëª©ë¡ ë Œë”ë§
        function renderPlacesList(stores) {
            const container = document.getElementById('places-container');
            if (!container) {
                console.error('places-container ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            container.innerHTML = '';
            
            if (stores.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">í‘œì‹œí•  ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            stores.forEach((store, index) => {
                const color = categoryColors[store.category] || '#a29bfe';
                const placeElement = document.createElement('div');
                placeElement.className = 'place-item';
                
                const benefitHtml = store.recommendedBenefit ? 
                    `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #0ea5e9;">
                        <span style="color: #0c4a6e; font-size: 0.85rem; font-weight: 500;">ğŸ ${store.recommendedBenefit}</span>
                    </div>` : '';
                
                placeElement.innerHTML = `
                    <div class="place-marker-num" style="background-color: ${color};">${index + 1}</div>
                    <div class="place-info">
                        <div class="place-name">
                            ${store.name}
                            <span class="place-category" style="background-color: ${color};">${store.category}</span>
                        </div>
                        <div class="place-desc">
                            ğŸ“ ${store.area} | ${store.desc}
                            ${store.reviews ? ` | â­ ${store.reviews}ê°œ ë¦¬ë·°` : ''}
                        </div>
                        ${benefitHtml}
                    </div>
                `;
                
                // í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì´ë™
                placeElement.addEventListener('click', () => {
                    const markerItem = markers[index];
                    if (markerItem && markerItem.marker) {
                        const position = markerItem.marker.getPosition();
                        map.setCenter(position);
                        map.setLevel(3);
                        
                        // ì¸í¬ìœˆë„ìš° ì—´ê¸°
                        setTimeout(() => {
                            closeAllInfoWindows();
                            markerItem.infoWindow.open(map, markerItem.marker);
                        }, 300);
                    }
                });
                
                container.appendChild(placeElement);
            });
            
            console.log(`ì¥ì†Œ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ: ${stores.length}ê°œ`);
        }
        
        // ì¹´í…Œê³ ë¦¬ í•„í„°ë§
        function filterByCategory(category) {
            let filteredStores;
            
            if (category === 'all') {
                filteredStores = allStores;
            } else if (category === 'ê¸°íƒ€') {
                const mainCategories = ['ìŒì‹ì ', 'ì¹´í˜', 'ì„œì ', 'ìˆ™ë°•', 'ì²´í—˜'];
                filteredStores = allStores.filter(store => !mainCategories.includes(store.category));
            } else {
                filteredStores = allStores.filter(store => store.category === category);
            }
            
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°í•˜ê³  ìƒˆë¡œ ìƒì„±
            clearMarkers();
            
            // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ì„ì‹œ êµì²´
            const originalStores = allStores;
            allStores = filteredStores;
            createMarkers();
            allStores = originalStores;
            
            renderPlacesList(filteredStores);
            updateStats(category, filteredStores.length);
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(selectedCategory = 'ì „ì²´', visibleCount = null) {
            const totalPlaces = document.getElementById('total-places');
            const visiblePlaces = document.getElementById('visible-places');
            const selectedCat = document.getElementById('selected-category');
            
            if (totalPlaces) totalPlaces.textContent = allStores.length;
            if (visiblePlaces) visiblePlaces.textContent = visibleCount !== null ? visibleCount : allStores.length;
            if (selectedCat) selectedCat.textContent = selectedCategory;
        }
        
        // íŒ¨ìŠ¤ í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
        function updatePassHeader(passData) {
            const titleElement = document.querySelector('.map-title');
            const subtitleElement = document.querySelector('.map-subtitle');
            const placesTitleElement = document.getElementById('places-title');
            
            if (titleElement) {
                titleElement.textContent = `${passData.pass_type} - AI ì¶”ì²œ ì¥ì†Œ`;
            }
            if (subtitleElement) {
                subtitleElement.textContent = `${passData.theme} í…Œë§ˆë¡œ ì„ ë³„ëœ ${passData.stores.length}ê°œ ì¥ì†Œ`;
            }
            if (placesTitleElement) {
                placesTitleElement.textContent = `ğŸ“ ${passData.pass_type}ì— í¬í•¨ëœ ì¶”ì²œ ì¥ì†Œë“¤`;
            }
        }

        // ê¸°ë³¸ í—¤ë” ì„¤ì •
        function updateDefaultHeader() {
            const titleElement = document.querySelector('.map-title');
            const subtitleElement = document.querySelector('.map-subtitle');
            const placesTitleElement = document.getElementById('places-title');
            
            if (titleElement) {
                titleElement.textContent = 'AI ì¶”ì²œ ì¥ì†Œ ì§€ë„';
            }
            if (subtitleElement) {
                subtitleElement.textContent = 'ë™ì¸ì²œì˜ ìˆ¨ê²¨ì§„ ë³´ì„ê°™ì€ ì¥ì†Œë“¤ì„ ë°œê²¬í•´ë³´ì„¸ìš”';
            }
            if (placesTitleElement) {
                placesTitleElement.textContent = 'ğŸ“ ëª¨ë“  ì¶”ì²œ ì¥ì†Œë“¤';
            }
        }
        
        // ê¸¸ì°¾ê¸° ê¸°ëŠ¥
        function showRoute(lat, lng, name) {
            const kakaoMapUrl = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
            window.open(kakaoMapUrl, '_blank');
        }
        
        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            console.error('ì˜¤ë¥˜:', message);
            document.getElementById('map-loading').style.display = 'none';
            document.getElementById('map').innerHTML = `
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #f8fafc; color: #64748b; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                    <h3 style="margin-bottom: 1rem; color: #ef4444;">ì§€ë„ ë¡œë“œ ì˜¤ë¥˜</h3>
                    <p style="margin-bottom: 2rem; line-height: 1.5;">${message}</p>
                    <button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
        }
        
        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');
            
            // ì¹´ì¹´ì˜¤ ì§€ë„ API í™•ì¸
            if (typeof kakao === 'undefined') {
                console.error('ì¹´ì¹´ì˜¤ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                showError('ì¹´ì¹´ì˜¤ ì§€ë„ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!kakao.maps) {
                console.error('ì¹´ì¹´ì˜¤ ì§€ë„ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤');
                showError('ì¹´ì¹´ì˜¤ ì§€ë„ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ í™•ì¸ ì™„ë£Œ');
            
            // ì§€ë„ ì´ˆê¸°í™”
            kakao.maps.load(() => {
                console.log('ì¹´ì¹´ì˜¤ ë§µ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
                initMap();
            });
            
            // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // í™œì„± ìƒíƒœ í† ê¸€
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ì¹´í…Œê³ ë¦¬ í•„í„°ë§
                    const category = this.dataset.category;
                    filterByCategory(category);
                });
            });
        });
    </script>
    </script>
</body>
</html>