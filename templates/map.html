<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제물포GO 패스 - 추천 장소 지도</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        .back-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .map-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .map-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .map-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .map-subtitle {
            opacity: 0.9;
        }
        
        #map {
            width: 100%;
            height: 600px;
        }
        
        .controls {
            padding: 1.5rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        
        .filter-btn {
            background: white;
            border: 2px solid #e2e8f0;
            color: #64748b;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .legend {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .legend-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .legend-text {
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.1rem;
            color: #64748b;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #e53e3e;
            background: #fed7d7;
            border-radius: 10px;
            margin: 1rem;
        }
        
        .places-list {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .places-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .place-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, #f8f9ff, #e6e9ff);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .place-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .place-marker-num {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            font-size: 14px;
        }
        
        .place-info {
            flex: 1;
        }
        
        .place-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }
        
        .place-desc {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .place-category {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 1rem;
            }
            
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">제물포GO 패스</div>
            <div>
                <a href="/main" class="back-btn">메인</a>
                <a href="/pass-generator" class="back-btn">패스 생성</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="map-container">
            <div class="map-header">
                <div class="map-title">AI 추천 장소 지도</div>
                <div class="map-subtitle">동인천의 숨겨진 보석같은 장소들을 발견해보세요</div>
            </div>
            
            <div id="map-loading" class="loading">
                <div class="spinner"></div>
                <div>지도를 불러오는 중...</div>
            </div>
            <div id="map"></div>
            
            <div class="controls">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-category="all">전체</button>
                    <button class="filter-btn" data-category="음식점">음식점</button>
                    <button class="filter-btn" data-category="카페">카페</button>
                    <button class="filter-btn" data-category="서점">서점</button>
                    <button class="filter-btn" data-category="숙박">숙박</button>
                    <button class="filter-btn" data-category="체험">체험</button>
                    <button class="filter-btn" data-category="기타">기타</button>
                </div>
            </div>
        </div>
        
        <div class="places-list">
            <div class="places-title" id="places-title">📍 AI가 추천한 장소들</div>
            <div id="places-container">
                <!-- 장소 목록이 여기에 표시됩니다 -->
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-title">카테고리별 마커</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-marker" style="background: #ff6b6b;"></div>
                    <span class="legend-text">음식점</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #4ecdc4;"></div>
                    <span class="legend-text">카페</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #45b7d1;"></div>
                    <span class="legend-text">서점</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #96ceb4;"></div>
                    <span class="legend-text">숙박</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #feca57;"></div>
                    <span class="legend-text">체험</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background: #a29bfe;"></div>
                    <span class="legend-text">기타</span>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="total-places">0</div>
                    <div class="stat-label">총 장소</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="visible-places">0</div>
                    <div class="stat-label">표시된 장소</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="selected-category">전체</div>
                    <div class="stat-label">선택된 카테고리</div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}"></script>
    <script>
        let map;
        let markers = [];
        let allStores = [];
        
        // 카테고리별 색상 매핑
        const categoryColors = {
            '음식점': '#ff6b6b',
            '카페': '#4ecdc4',
            '서점': '#45b7d1',
            '숙박': '#96ceb4',
            '체험': '#feca57',
            '주점': '#fd79a8',
            '의류': '#fdcb6e',
            '약국': '#6c5ce7',
            '서비스': '#a29bfe',
            '편의점': '#00b894',
            '꽃집': '#e17055',
            '오락': '#74b9ff',
            '문구점': '#81ecec',
            '제과점': '#fab1a0',
            '기념품': '#55a3ff'
        };
        
        // 지도 초기화
        function initMap() {
            console.log('지도 초기화 시작');
            
            try {
                // 로딩 표시
                document.getElementById('map-loading').style.display = 'flex';
                
                const container = document.getElementById('map');
                const options = {
                    center: new kakao.maps.LatLng(37.4755, 126.6166), // 동인천 중심
                    level: 4
                };
                
                map = new kakao.maps.Map(container, options);
                console.log('카카오 지도 생성 완료:', map);
                
                // 로딩 숨기기
                setTimeout(() => {
                    document.getElementById('map-loading').style.display = 'none';
                }, 500);
                
                // 매장 데이터 로드
                setTimeout(loadStores, 1000);
                
            } catch (error) {
                console.error('지도 초기화 오류:', error);
                showError('지도를 초기화할 수 없습니다: ' + error.message);
            }
        }
        
        // 패스 데이터 로드 (세션 스토리지에서)
        function loadPassData() {
            try {
                const passDataStr = sessionStorage.getItem('currentPassData');
                if (passDataStr) {
                    const passData = JSON.parse(passDataStr);
                    console.log('패스 데이터 로드:', passData);
                    return passData;
                }
                console.log('세션 스토리지에 패스 데이터 없음');
                return null;
            } catch (error) {
                console.error('패스 데이터 파싱 오류:', error);
                return null;
            }
        }

        // 매장 데이터 로드
        async function loadStores() {
            console.log('매장 데이터 로드 시작');
            
            try {
                // 먼저 패스 데이터 확인
                const passData = loadPassData();
                
                if (passData && passData.stores && passData.stores.length > 0) {
                    console.log('패스에서 추천된 매장들:', passData.stores);
                    
                    // 전체 매장 데이터 가져오기
                    const response = await fetch('/api/stores');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('🌐 API 전체 응답:', data);
                    console.log('✅ API 성공 여부:', data.success);
                    console.log('📊 API 매장 수:', data.count);
                    
                    if (data.success && data.stores) {
                        // 추천된 매장들만 필터링
                        const recommendedStoreNames = passData.stores.map(store => store.name);
                        const filteredStores = data.stores.filter(store => 
                            recommendedStoreNames.includes(store.name)
                        );
                        
                        // 추천된 매장의 혜택 정보도 추가
                        filteredStores.forEach(store => {
                            const passStore = passData.stores.find(ps => ps.name === store.name);
                            if (passStore) {
                                store.recommendedBenefit = passStore.desc;
                            }
                        });
                        
                        allStores = filteredStores;
                        console.log('✨ 패스에서 추천된', filteredStores.length, '개 매장 로드');
                        
                        // 첫 번째 매장의 좌표 확인
                        if (filteredStores.length > 0) {
                            const firstStore = filteredStores[0];
                            console.log('🎯 첫 번째 매장 샘플:', {
                                name: firstStore.name,
                                latitude: firstStore.latitude,
                                longitude: firstStore.longitude,
                                hasCoordinates: !!(firstStore.latitude && firstStore.longitude)
                            });
                        }
                        
                        // 패스 정보 업데이트
                        updatePassHeader(passData);
                    } else {
                        throw new Error('매장 데이터 형식 오류');
                    }
                } else {
                    console.log('패스 데이터가 없음, 전체 매장 표시');
                    // 패스 데이터가 없으면 전체 매장 표시
                    const response = await fetch('/api/stores');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.stores) {
                        allStores = data.stores;
                        console.log('🌐 전체', allStores.length, '개 매장 로드');
                        
                        // 첫 번째 매장의 좌표 확인
                        if (allStores.length > 0) {
                            const firstStore = allStores[0];
                            console.log('🎯 첫 번째 매장 샘플:', {
                                name: firstStore.name,
                                latitude: firstStore.latitude,
                                longitude: firstStore.longitude,
                                hasCoordinates: !!(firstStore.latitude && firstStore.longitude)
                            });
                        }
                        
                        // 기본 헤더 설정
                        updateDefaultHeader();
                    } else {
                        throw new Error('매장 데이터 형식 오류');
                    }
                }
                
                // 마커 생성 및 표시
                console.log('📍 마커 생성 시작 - 총', allStores.length, '개 매장');
                createMarkers();
                renderPlacesList(allStores);
                updateStats();
                
            } catch (error) {
                console.error('매장 데이터 로드 오류:', error);
                // 샘플 데이터로 폴백
                loadSampleData();
            }
        }
        
        // 샘플 데이터 로드
        function loadSampleData() {
            console.log('샘플 데이터 사용');
            allStores = [
                {
                    id: 'S001',
                    name: '월미도 횟집',
                    category: '음식점',
                    area: '월미도',
                    themes: ['해산물', '바다전망'],
                    desc: '신선한 해산물을 즐길 수 있는 곳',
                    latitude: 37.47397220206862,
                    longitude: 126.59720509293857,
                    reviews: 250
                },
                {
                    id: 'S002',
                    name: '문학소매점',
                    category: '서점',
                    area: '개항로',
                    themes: ['레트로', '독립서점'],
                    desc: '오래된 책과 이야기가 있는 곳',
                    latitude: 37.47350937581703,
                    longitude: 126.62085286165087,
                    reviews: 15
                },
                {
                    id: 'S003',
                    name: '원보만두',
                    category: '음식점',
                    area: '차이나타운',
                    themes: ['중식', '전통'],
                    desc: '전통 방식으로 만든 수제 만두',
                    latitude: 37.47534097822377,
                    longitude: 126.6191021259768,
                    reviews: 180
                },
                {
                    id: 'S004',
                    name: '블루하라',
                    category: '카페',
                    area: '골목상권',
                    themes: ['조용함', '핸드드립'],
                    desc: '조용한 골목 속 숨은 카페',
                    latitude: 37.474785094782234,
                    longitude: 126.6197545384214,
                    reviews: 30
                },
                {
                    id: 'S005',
                    name: '바다풍경 펜션카페',
                    category: '카페',
                    area: '월미도',
                    themes: ['바다전망', '펜션'],
                    desc: '바다를 보며 커피를 마실 수 있는 곳',
                    latitude: 37.4758,
                    longitude: 126.5951,
                    reviews: 120
                }
            ];
            
            createMarkers();
            renderPlacesList(allStores);
            updateStats();
        }
        
        // 마커 생성 (간단하고 확실한 방법)
        function createMarkers() {
            console.log('마커 생성 시작, 매장 수:', allStores.length);
            
            // 기존 마커 제거
            clearMarkers();
            
            if (!map) {
                console.error('지도 객체가 없습니다');
                return;
            }
            
            let validMarkerCount = 0;
            const bounds = new kakao.maps.LatLngBounds();
            
            allStores.forEach((store, index) => {
                if (store.latitude && store.longitude) {
                    try {
                        const position = new kakao.maps.LatLng(store.latitude, store.longitude);
                        console.log(`마커 ${index + 1} 위치:`, store.name, position.getLat(), position.getLng());
                        
                        // 기본 마커 생성 (먼저 단순한 마커로)
                        const marker = new kakao.maps.Marker({
                            position: position,
                            map: map,
                            title: store.name
                        });
                        
                        console.log(`마커 ${index + 1} 생성:`, marker);
                        
                        // 인포윈도우 생성
                        const infoWindow = createInfoWindow(store, index + 1);
                        
                        // 마커 클릭 이벤트
                        kakao.maps.event.addListener(marker, 'click', function() {
                            console.log('마커 클릭:', store.name);
                            // 다른 인포윈도우 닫기
                            closeAllInfoWindows();
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push({
                            marker: marker,
                            infoWindow: infoWindow,
                            store: store
                        });
                        
                        bounds.extend(position);
                        validMarkerCount++;
                        
                        console.log(`마커 ${index + 1} 생성 완료: ${store.name}`);
                        
                    } catch (error) {
                        console.error(`마커 생성 오류 (${store.name}):`, error);
                    }
                } else {
                    console.warn(`좌표 정보 없음: ${store.name}`);
                }
            });
            
            console.log(`총 ${validMarkerCount}개 마커 생성 완료`);
            console.log('생성된 마커들:', markers);
            
            // 지도 범위 조정
            if (validMarkerCount > 0) {
                try {
                    console.log('지도 범위 조정 중...');
                    map.setBounds(bounds);
                    
                    // 단일 마커인 경우 적절한 줌 레벨 설정
                    setTimeout(() => {
                        if (validMarkerCount === 1) {
                            map.setLevel(4);
                        } else if (map.getLevel() > 6) {
                            map.setLevel(6);
                        }
                        console.log('지도 레벨 조정 완료:', map.getLevel());
                    }, 500);
                    
                } catch (error) {
                    console.error('지도 범위 조정 오류:', error);
                }
            } else {
                console.warn('표시할 마커가 없습니다');
            }
        }
        
        // 기존 마커 제거
        function clearMarkers() {
            markers.forEach(item => {
                if (item.marker) {
                    item.marker.setMap(null);
                }
                if (item.infoWindow) {
                    item.infoWindow.close();
                }
            });
            markers = [];
        }
        
        // 모든 인포윈도우 닫기
        function closeAllInfoWindows() {
            markers.forEach(item => {
                if (item.infoWindow) {
                    item.infoWindow.close();
                }
            });
        }
        
        // 인포윈도우 생성
        function createInfoWindow(store, number) {
            const themes = Array.isArray(store.themes) ? store.themes.join(', ') : '';
            const reviewText = store.reviews ? `⭐ ${store.reviews}개 리뷰` : '';
            const benefitText = store.recommendedBenefit ? `🎁 ${store.recommendedBenefit}` : '';
            const color = categoryColors[store.category] || '#a29bfe';
            
            const content = `
                <div style="padding: 15px; min-width: 280px; max-width: 350px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="width: 24px; height: 24px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 10px;">${number}</div>
                        <h3 style="margin: 0; color: #1a202c; font-size: 16px; font-weight: bold;">${store.name}</h3>
                    </div>
                    <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${store.category}</span>
                        <span style="color: #64748b; font-size: 12px;">${store.area}</span>
                    </div>
                    <p style="margin: 8px 0; color: #4a5568; font-size: 14px; line-height: 1.5;">${store.desc}</p>
                    ${benefitText ? `<div style="margin: 12px 0; padding: 8px; background: #f0f9ff; border-left: 4px solid #0ea5e9; border-radius: 4px;"><div style="color: #0c4a6e; font-size: 13px; font-weight: 500;">${benefitText}</div></div>` : ''}
                    ${themes ? `<div style="margin: 8px 0; color: #667eea; font-size: 12px;"><strong>테마:</strong> ${themes}</div>` : ''}
                    ${reviewText ? `<div style="margin: 8px 0; color: #ed8936; font-size: 12px;">${reviewText}</div>` : ''}
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="showRoute(${store.latitude}, ${store.longitude}, '${store.name}')" style="background: ${color}; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">길찾기</button>
                    </div>
                </div>
            `;
            
            return new kakao.maps.InfoWindow({
                content: content,
                removable: true
            });
        }
        
        // 장소 목록 렌더링
        function renderPlacesList(stores) {
            const container = document.getElementById('places-container');
            if (!container) {
                console.error('places-container 요소를 찾을 수 없습니다');
                return;
            }
            
            container.innerHTML = '';
            
            if (stores.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">표시할 장소가 없습니다.</div>';
                return;
            }
            
            stores.forEach((store, index) => {
                const color = categoryColors[store.category] || '#a29bfe';
                const placeElement = document.createElement('div');
                placeElement.className = 'place-item';
                
                const benefitHtml = store.recommendedBenefit ? 
                    `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #0ea5e9;">
                        <span style="color: #0c4a6e; font-size: 0.85rem; font-weight: 500;">🎁 ${store.recommendedBenefit}</span>
                    </div>` : '';
                
                placeElement.innerHTML = `
                    <div class="place-marker-num" style="background-color: ${color};">${index + 1}</div>
                    <div class="place-info">
                        <div class="place-name">
                            ${store.name}
                            <span class="place-category" style="background-color: ${color};">${store.category}</span>
                        </div>
                        <div class="place-desc">
                            📍 ${store.area} | ${store.desc}
                            ${store.reviews ? ` | ⭐ ${store.reviews}개 리뷰` : ''}
                        </div>
                        ${benefitHtml}
                    </div>
                `;
                
                // 클릭 시 해당 마커로 이동
                placeElement.addEventListener('click', () => {
                    const markerItem = markers[index];
                    if (markerItem && markerItem.marker) {
                        const position = markerItem.marker.getPosition();
                        map.setCenter(position);
                        map.setLevel(3);
                        
                        // 인포윈도우 열기
                        setTimeout(() => {
                            closeAllInfoWindows();
                            markerItem.infoWindow.open(map, markerItem.marker);
                        }, 300);
                    }
                });
                
                container.appendChild(placeElement);
            });
            
            console.log(`장소 목록 렌더링 완료: ${stores.length}개`);
        }
        
        // 카테고리 필터링
        function filterByCategory(category) {
            let filteredStores;
            
            if (category === 'all') {
                filteredStores = allStores;
            } else if (category === '기타') {
                const mainCategories = ['음식점', '카페', '서점', '숙박', '체험'];
                filteredStores = allStores.filter(store => !mainCategories.includes(store.category));
            } else {
                filteredStores = allStores.filter(store => store.category === category);
            }
            
            // 기존 마커 제거하고 새로 생성
            clearMarkers();
            
            // 필터링된 데이터로 임시 교체
            const originalStores = allStores;
            allStores = filteredStores;
            createMarkers();
            allStores = originalStores;
            
            renderPlacesList(filteredStores);
            updateStats(category, filteredStores.length);
        }
        
        // 통계 업데이트
        function updateStats(selectedCategory = '전체', visibleCount = null) {
            const totalPlaces = document.getElementById('total-places');
            const visiblePlaces = document.getElementById('visible-places');
            const selectedCat = document.getElementById('selected-category');
            
            if (totalPlaces) totalPlaces.textContent = allStores.length;
            if (visiblePlaces) visiblePlaces.textContent = visibleCount !== null ? visibleCount : allStores.length;
            if (selectedCat) selectedCat.textContent = selectedCategory;
        }
        
        // 패스 헤더 정보 업데이트
        function updatePassHeader(passData) {
            const titleElement = document.querySelector('.map-title');
            const subtitleElement = document.querySelector('.map-subtitle');
            const placesTitleElement = document.getElementById('places-title');
            
            if (titleElement) {
                titleElement.textContent = `${passData.pass_type} - AI 추천 장소`;
            }
            if (subtitleElement) {
                subtitleElement.textContent = `${passData.theme} 테마로 선별된 ${passData.stores.length}개 장소`;
            }
            if (placesTitleElement) {
                placesTitleElement.textContent = `📍 ${passData.pass_type}에 포함된 추천 장소들`;
            }
        }

        // 기본 헤더 설정
        function updateDefaultHeader() {
            const titleElement = document.querySelector('.map-title');
            const subtitleElement = document.querySelector('.map-subtitle');
            const placesTitleElement = document.getElementById('places-title');
            
            if (titleElement) {
                titleElement.textContent = 'AI 추천 장소 지도';
            }
            if (subtitleElement) {
                subtitleElement.textContent = '동인천의 숨겨진 보석같은 장소들을 발견해보세요';
            }
            if (placesTitleElement) {
                placesTitleElement.textContent = '📍 모든 추천 장소들';
            }
        }
        
        // 길찾기 기능
        function showRoute(lat, lng, name) {
            const kakaoMapUrl = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
            window.open(kakaoMapUrl, '_blank');
        }
        
        // 에러 표시
        function showError(message) {
            console.error('오류:', message);
            document.getElementById('map-loading').style.display = 'none';
            document.getElementById('map').innerHTML = `
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #f8fafc; color: #64748b; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                    <h3 style="margin-bottom: 1rem; color: #ef4444;">지도 로드 오류</h3>
                    <p style="margin-bottom: 2rem; line-height: 1.5;">${message}</p>
                    <button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">다시 시도</button>
                </div>
            `;
        }
        
        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로드 완료');
            
            // 카카오 지도 API 확인
            if (typeof kakao === 'undefined') {
                console.error('카카오 지도 API가 로드되지 않았습니다');
                showError('카카오 지도 API를 불러올 수 없습니다. 네트워크 연결을 확인해주세요.');
                return;
            }
            
            if (!kakao.maps) {
                console.error('카카오 지도 모듈이 없습니다');
                showError('카카오 지도 모듈을 불러올 수 없습니다.');
                return;
            }
            
            console.log('카카오 지도 API 로드 확인 완료');
            
            // 지도 초기화
            kakao.maps.load(() => {
                console.log('카카오 맵 라이브러리 로드 완료');
                initMap();
            });
            
            // 필터 버튼 이벤트
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 활성 상태 토글
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 카테고리 필터링
                    const category = this.dataset.category;
                    filterByCategory(category);
                });
            });
        });
    </script>
    </script>
</body>
</html>